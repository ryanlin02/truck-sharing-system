<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大貨車業務資訊共享系統</title>
    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-storage-compat.min.js"></script>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#3498db">
    
    <!-- CSS 樣式 -->
    <style>
        :root {
            /* 顏色變數 */
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --text-color: #333;
            --bg-color: #f9f9f9;
            --card-bg: #fff;
            --border-color: #ddd;
            
            /* 字體變數 */
            --font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', sans-serif;
            --font-size-sm: 0.875rem;
            --font-size-md: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-xxl: 1.5rem;
            
            /* 間距變數 */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            
            /* 陰影變數 */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --shadow-md: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
            --shadow-lg: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
            
            /* 圓角變數 */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 16px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: var(--font-family);
            font-size: var(--font-size-md);
            color: var(--text-color);
            background-color: var(--bg-color);
            line-height: 1.6;
            padding-bottom: 60px; /* 為底部導航留出空間 */
        }
        
        /* 頁面容器 */
        .container {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            padding: var(--spacing-md);
        }
        
        /* 標題樣式 */
        h1, h2, h3, h4, h5, h6 {
            color: var(--secondary-color);
            margin-bottom: var(--spacing-md);
        }
        
        h1 {
            font-size: var(--font-size-xxl);
            text-align: center;
        }
        
        h2 {
            font-size: var(--font-size-xl);
        }
        
        h3 {
            font-size: var(--font-size-lg);
        }
        
        /* 按鈕樣式 */
        .btn {
            display: inline-block;
            padding: var(--spacing-sm) var(--spacing-md);
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: var(--font-size-md);
            text-align: center;
            text-decoration: none;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        /* 表單樣式 */
        .form-group {
            margin-bottom: var(--spacing-md);
        }
        
        label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: bold;
        }
        
        input, select, textarea {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-family: var(--font-family);
            font-size: var(--font-size-md);
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        /* 卡片樣式 */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-md);
            overflow: hidden;
            position: relative;
        }
        
        .card-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        
        .card-content {
            padding: var(--spacing-md);
        }
        
        .card-title {
            font-size: var(--font-size-lg);
            margin-bottom: var(--spacing-xs);
            color: var(--dark-color);
        }
        
        .card-price {
            font-size: var(--font-size-xl);
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: var(--spacing-xs);
        }
        
        .card-info {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-sm);
        }
        
        .card-info span {
            background: var(--light-color);
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
        }
        
        .card-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 3px 10px;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            font-weight: bold;
            color: white;
        }
        
        .status-available {
            background-color: var(--success-color);
        }
        
        .status-pending {
            background-color: var(--warning-color);
        }
        
        .status-sold {
            background-color: var(--danger-color);
        }
        
        /* 搜尋過濾區塊 */
        .filter-section {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-md);
        }
        
        .filter-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .filter-toggle h3 {
            margin-bottom: 0;
        }
        
        .filter-content {
            display: none;
            margin-top: var(--spacing-md);
        }
        
        .filter-content.show {
            display: block;
        }
        
        .filter-row {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
        }
        
        .filter-group {
            flex: 1;
        }
        
        /* 導航欄 */
        .navbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            padding: var(--spacing-xs) 0;
            z-index: 1000;
        }
        
        .nav-item {
            text-align: center;
            flex: 1;
            padding: var(--spacing-xs);
            color: var(--secondary-color);
            text-decoration: none;
            font-size: var(--font-size-sm);
        }
        
        .nav-item.active {
            color: var(--primary-color);
        }
        
        .nav-icon {
            font-size: 1.5rem;
            margin-bottom: 2px;
        }
        
        /* 模態視窗 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            overflow-y: auto;
        }
        
        .modal-content {
            background: white;
            margin: 20px auto;
            max-width: 480px;
            border-radius: var(--radius-md);
            overflow: hidden;
        }
        
        .modal-header {
            padding: var(--spacing-md);
            background: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: var(--spacing-md);
        }
        
        .modal-footer {
            padding: var(--spacing-md);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-md);
            border-top: 1px solid var(--border-color);
        }
        
        .close {
            font-size: 1.5rem;
            cursor: pointer;
            color: white;
        }
        
        /* 詳情頁車輛圖片輪播 */
        .image-slider {
            position: relative;
            width: 100%;
            height: 250px;
            overflow: hidden;
        }
        
        .slider-container {
            display: flex;
            transition: transform 0.3s ease-in-out;
            height: 100%;
        }
        
        .slider-image {
            min-width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .slider-nav {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 8px;
        }
        
        .slider-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            cursor: pointer;
        }
        
        .slider-dot.active {
            background: white;
        }
        
        /* 懸浮添加按鈕 */
        .fab {
            position: fixed;
            bottom: 70px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            box-shadow: var(--shadow-md);
            z-index: 900;
            cursor: pointer;
        }
        
        /* 圖片上傳預覽區域 */
        .image-upload {
            margin-bottom: var(--spacing-md);
        }
        
        .preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }
        
        .image-preview {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-sm);
            overflow: hidden;
            position: relative;
        }
        
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-image {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            background: rgba(0,0,0,0.5);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            cursor: pointer;
        }
        
        /* 無限滾動加載指示器 */
        .loading {
            text-align: center;
            padding: var(--spacing-md);
            display: none;
        }
        
        /* 響應式調整 */
        @media (min-width: 768px) {
            .container {
                max-width: 720px;
            }
            
            .card-list {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: var(--spacing-md);
            }
        }
        
        /* 頁面切換效果 */
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* 工具類 */
        .text-center {
            text-align: center;
        }
        
        .mb-1 {
            margin-bottom: var(--spacing-sm);
        }
        
        .mb-2 {
            margin-bottom: var(--spacing-md);
        }
        
        .mb-3 {
            margin-bottom: var(--spacing-lg);
        }
        
        .mt-1 {
            margin-top: var(--spacing-sm);
        }
        
        .mt-2 {
            margin-top: var(--spacing-md);
        }
        
        .mt-3 {
            margin-top: var(--spacing-lg);
        }
    </style>
</head>
<body>
    <!-- 應用程式容器 -->
    <div id="app">
        <!-- 車輛列表頁面 -->
        <div id="home-page" class="page active">
            <div class="container">
                <h1>大貨車資訊系統</h1>
                
                <!-- 搜尋過濾區塊 -->
                <div class="filter-section">
                    <div class="filter-toggle" id="filterToggle">
                        <h3>搜尋與篩選</h3>
                        <span class="toggle-icon">▼</span>
                    </div>
                    <div class="filter-content" id="filterContent">
                        <!-- 關鍵字搜尋 -->
                        <div class="form-group mb-2">
                            <input type="text" id="search-keyword" placeholder="輸入關鍵字搜尋...">
                        </div>
                        
                        <!-- 條件篩選 -->
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="brand-filter">廠牌</label>
                                <select id="brand-filter">
                                    <option value="">所有廠牌</option>
                                    <option value="isuzu">五十鈴</option>
                                    <option value="hino">日野</option>
                                    <option value="fuso">三菱扶桑</option>
                                    <option value="volvo">富豪</option>
                                    <option value="scania">斯堪尼亞</option>
                                    <option value="mercedes">賓士</option>
                                    <option value="man">曼恩</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="type-filter">車型</label>
                                <select id="type-filter">
                                    <option value="">所有車型</option>
                                    <option value="flatbed">平板車</option>
                                    <option value="dump">砂石車</option>
                                    <option value="cargo">貨櫃車</option>
                                    <option value="refrigerated">冷凍車</option>
                                    <option value="tanker">槽車</option>
                                    <option value="crane">吊車</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="price-min">價格範圍</label>
                                <div style="display: flex; gap: 8px;">
                                    <input type="number" id="price-min" placeholder="最低價">
                                    <input type="number" id="price-max" placeholder="最高價">
                                </div>
                            </div>
                            <div class="filter-group">
                                <label for="year-min">年份範圍</label>
                                <div style="display: flex; gap: 8px;">
                                    <input type="number" id="year-min" placeholder="最舊">
                                    <input type="number" id="year-max" placeholder="最新">
                                </div>
                            </div>
                        </div>
                        
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="weight-filter">載重噸數</label>
                                <select id="weight-filter">
                                    <option value="">所有噸數</option>
                                    <option value="3.5">3.5噸以下</option>
                                    <option value="5">5噸</option>
                                    <option value="8">8噸</option>
                                    <option value="10">10噸</option>
                                    <option value="15">15噸以上</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="length-filter">車身長度</label>
                                <select id="length-filter">
                                    <option value="">所有長度</option>
                                    <option value="14">14呎</option>
                                    <option value="17">17呎</option>
                                    <option value="20">20呎</option>
                                    <option value="24">24呎</option>
                                    <option value="35">35呎以上</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="sort-by">排序方式</label>
                                <select id="sort-by">
                                    <option value="newest">最新上架</option>
                                    <option value="price-asc">價格由低至高</option>
                                    <option value="price-desc">價格由高至低</option>
                                    <option value="year-asc">年份由舊至新</option>
                                    <option value="year-desc">年份由新至舊</option>
                                    <option value="popular">最熱門</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="status-filter">車輛狀態</label>
                                <select id="status-filter">
                                    <option value="available">可售車輛</option>
                                    <option value="all">全部車輛</option>
                                    <option value="pending">洽談中</option>
                                    <option value="sold">已售出</option>
                                </select>
                            </div>
                        </div>
                        
                        <button class="btn btn-block mt-1" id="apply-filter">套用篩選</button>
                    </div>
                </div>
                
                <!-- 車輛列表 -->
                <div class="card-list" id="truck-list">
                    <!-- 車輛卡片會透過JavaScript動態生成 -->
                </div>
                
                <!-- 加載指示器 -->
                <div class="loading" id="loading">
                    <p>載入更多車輛...</p>
                </div>
            </div>
            
            <!-- 新增車輛按鈕 -->
            <div class="fab" id="add-truck-btn">+</div>
        </div>
        
        <!-- 車輛詳情頁面 -->
        <div id="detail-page" class="page">
            <div class="container">
                <div id="truck-detail">
                    <!-- 詳情內容由JavaScript動態生成 -->
                </div>
                <button class="btn btn-block mb-2" id="back-to-list">返回列表</button>
            </div>
        </div>
        
        <!-- 新增/編輯車輛頁面 -->
        <div id="edit-page" class="page">
            <div class="container">
                <h1 id="edit-title">新增車輛</h1>
                <form id="truck-form">
                    <input type="hidden" id="truck-id">
                    
                    <div class="form-group">
                        <label for="truck-brand">廠牌</label>
                        <select id="truck-brand" required>
                            <option value="">選擇廠牌</option>
                            <option value="isuzu">五十鈴</option>
                            <option value="hino">日野</option>
                            <option value="fuso">三菱扶桑</option>
                            <option value="volvo">富豪</option>
                            <option value="scania">斯堪尼亞</option>
                            <option value="mercedes">賓士</option>
                            <option value="man">曼恩</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-model">車型名稱</label>
                        <input type="text" id="truck-model" required placeholder="例：FUSO SUPER GREAT">
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-type">車型分類</label>
                        <select id="truck-type" required>
                            <option value="">選擇車型</option>
                            <option value="flatbed">平板車</option>
                            <option value="dump">砂石車</option>
                            <option value="cargo">貨櫃車</option>
                            <option value="refrigerated">冷凍車</option>
                            <option value="tanker">槽車</option>
                            <option value="crane">吊車</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-price">售價 (萬元)</label>
                        <input type="number" id="truck-price" required min="0" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-year">出廠年份</label>
                        <input type="number" id="truck-year" required min="1980" max="2030">
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-weight">載重噸數</label>
                        <input type="number" id="truck-weight" required min="0" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-length">車身長度 (呎)</label>
                        <input type="number" id="truck-length" required min="0" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-engine">引擎規格</label>
                        <input type="text" id="truck-engine" placeholder="例：400匹/12800cc">
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-condition">車況評級</label>
                        <select id="truck-condition" required>
                            <option value="excellent">優良 (近乎全新)</option>
                            <option value="good">良好 (正常使用痕跡)</option>
                            <option value="fair">普通 (有些許問題但可正常使用)</option>
                            <option value="poor">較差 (需要維修)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-status">銷售狀態</label>
                        <select id="truck-status" required>
                            <option value="available">可售</option>
                            <option value="pending">洽談中</option>
                            <option value="sold">已售出</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-description">車輛描述</label>
                        <textarea id="truck-description" rows="5" placeholder="詳細描述車輛特點、使用狀況、特殊配備等..."></textarea>
                    </div>
                    
                    <div class="form-group image-upload">
                        <label>上傳車輛照片</label>
                        <input type="file" id="truck-images" multiple accept="image/*">
                        <div class="preview-container" id="image-previews"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="seller-name">負責業務</label>
                        <input type="text" id="seller-name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="seller-contact">聯絡方式</label>
                        <input type="text" id="seller-contact" required placeholder="電話或LINE ID">
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-success btn-block">儲存車輛資訊</button>
                    </div>
                    
                    <div class="form-group">
                        <button type="button" class="btn btn-block" id="cancel-edit">取消</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 登入頁面（預留） -->
        <div id="login-page" class="page">
            <div class="container">
                <h1 class="mb-3">業務登入</h1>
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-email">電子郵件</label>
                        <input type="email" id="login-email" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">密碼</label>
                        <input type="password" id="login-password" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-success btn-block">登入</button>
                    </div>
                    <p class="text-center mt-2">
                        <a href="#" id="register-link">註冊新帳號</a>
                    </p>
                </form>
            </div>
        </div>

        <!-- 導航欄 -->
        <div class="navbar">
            <a href="#" class="nav-item active" data-page="home-page">
                <div class="nav-icon">🏠</div>
                <div>首頁</div>
            </a>
            <a href="#" class="nav-item" data-page="">
                <div class="nav-icon">🔍</div>
                <div>搜尋</div>
            </a>
            <a href="#" class="nav-item" data-page="">
                <div class="nav-icon">👤</div>
                <div>我的</div>
            </a>
        </div>
    </div>

    <!-- JavaScript代碼 -->
    <script>
        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyCujF5qmtk7Jhmxh0qPFUIActnEc8ysLgg",
            authDomain: "truck-sharing-system.firebaseapp.com",
            projectId: "truck-sharing-system",
            storageBucket: "truck-sharing-system.firebasestorage.app",
            messagingSenderId: "706717228220",
            appId: "1:706717228220:web:f50b2e5d3c9436817004b9",
            measurementId: "G-0PBEWXX6C0"
        };

        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        const auth = firebase.auth();
        
        // 頁面元素引用
        const homePage = document.getElementById('home-page');
        const detailPage = document.getElementById('detail-page');
        const editPage = document.getElementById('edit-page');
        const loginPage = document.getElementById('login-page');
        const truckList = document.getElementById('truck-list');
        const truckDetail = document.getElementById('truck-detail');
        const filterToggle = document.getElementById('filterToggle');
        const filterContent = document.getElementById('filterContent');
        const addTruckBtn = document.getElementById('add-truck-btn');
        const backToListBtn = document.getElementById('back-to-list');
        const truckForm = document.getElementById('truck-form');
        const cancelEditBtn = document.getElementById('cancel-edit');
        const imagePreviews = document.getElementById('image-previews');
        const truckImagesInput = document.getElementById('truck-images');
        const loadingIndicator = document.getElementById('loading');
        
        // 全局變數
        let currentUser = null; // 當前登入用戶
        let lastVisibleTruck = null; // 分頁加載的最後一個文檔
        let isLoadingMore = false; // 是否正在加載更多
        let activeFilters = {}; // 活動篩選條件
        let editingImages = []; // 編輯時的圖片列表
        let truckImages = []; // 上傳的圖片檔案列表
        
        // ============ 頁面導航功能 ============
        
        // 顯示特定頁面
        function showPage(pageId) {
            // 隱藏所有頁面
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // 顯示指定頁面
            document.getElementById(pageId).classList.add('active');
            
            // 更新導航欄狀態
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.dataset.page === pageId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        // 導航欄點擊處理
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const pageId = this.dataset.page;
                if (pageId) {
                    showPage(pageId);
                }
            });
        });
        
        // ============ 車輛列表功能 ============
        
        // 載入車輛列表
        async function loadTrucks(isInitialLoad = false) {
            if (isLoadingMore) return;
            
            isLoadingMore = true;
            loadingIndicator.style.display = 'block';
            
            try {
                // 創建基礎查詢
                let query = db.collection('trucks');
                
                // 應用篩選條件
                if (activeFilters.status && activeFilters.status !== 'all') {
                    query = query.where('status', '==', activeFilters.status);
                }
                
                if (activeFilters.brand) {
                    query = query.where('brand', '==', activeFilters.brand);
                }
                
                if (activeFilters.type) {
                    query = query.where('type', '==', activeFilters.type);
                }
                
                // 添加排序
                switch (activeFilters.sortBy) {
                    case 'price-asc':
                        query = query.orderBy('price', 'asc');
                        break;
                    case 'price-desc':
                        query = query.orderBy('price', 'desc');
                        break;
                    case 'year-asc':
                        query = query.orderBy('year', 'asc');
                        break;
                    case 'year-desc':
                        query = query.orderBy('year', 'desc');
                        break;
                    case 'popular':
                        query = query.orderBy('views', 'desc');
                        break;
                    default:
                        query = query.orderBy('createdAt', 'desc'); // 默認按上架時間排序
                }
                
                // 分頁處理
                if (!isInitialLoad && lastVisibleTruck) {
                    query = query.startAfter(lastVisibleTruck);
                }
                
                // 限制每次加載數量
                query = query.limit(10);
                
                // 執行查詢
                const snapshots = await query.get();
                
                // 清空列表 (如果是初始載入)
                if (isInitialLoad) {
                    truckList.innerHTML = '';
                }
                
                // 更新最後可見文檔
                if (!snapshots.empty) {
                    lastVisibleTruck = snapshots.docs[snapshots.docs.length - 1];
                }
                
                if (snapshots.empty && isInitialLoad) {
                    truckList.innerHTML = '<p class="text-center">沒有符合條件的車輛</p>';
                    return;
                }
                
                // 渲染車輛卡片
                snapshots.forEach(doc => {
                    const truck = { id: doc.id, ...doc.data() };
                    truckList.appendChild(createTruckCard(truck));
                });
                
            } catch (error) {
                console.error('載入車輛失敗:', error);
                alert('載入車輛失敗，請稍後再試');
            } finally {
                isLoadingMore = false;
                loadingIndicator.style.display = 'none';
            }
        }
        
        // 創建車輛卡片元素
        function createTruckCard(truck) {
            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.id = truck.id;
            
            // 狀態標籤類別
            let statusClass = '';
            let statusText = '';
            
            switch (truck.status) {
                case 'available':
                    statusClass = 'status-available';
                    statusText = '可售';
                    break;
                case 'pending':
                    statusClass = 'status-pending';
                    statusText = '洽談中';
                    break;
                case 'sold':
                    statusClass = 'status-sold';
                    statusText = '已售出';
                    break;
            }
            
            // 品牌中文名稱對照
            const brandNames = {
                'isuzu': '五十鈴',
                'hino': '日野',
                'fuso': '三菱扶桑',
                'volvo': '富豪',
                'scania': '斯堪尼亞',
                'mercedes': '賓士',
                'man': '曼恩',
                'other': '其他'
            };
            
            // 車型中文名稱對照
            const typeNames = {
                'flatbed': '平板車',
                'dump': '砂石車',
                'cargo': '貨櫃車',
                'refrigerated': '冷凍車',
                'tanker': '槽車',
                'crane': '吊車',
                'other': '其他'
            };
            
            // 填充卡片內容
            card.innerHTML = `
                <div class="card-status ${statusClass}">${statusText}</div>
                <img src="${truck.images && truck.images.length > 0 ? truck.images[0] : '/api/placeholder/320/200'}" alt="${truck.brand} ${truck.model}" class="card-img">
                <div class="card-content">
                    <div class="card-price">${truck.price} 萬元</div>
                    <div class="card-title">${brandNames[truck.brand] || truck.brand} ${truck.model}</div>
                    <div class="card-info">
                        <span>${truck.year}年</span>
                        <span>${typeNames[truck.type] || truck.type}</span>
                        <span>${truck.weight}噸</span>
                        <span>${truck.length}呎</span>
                    </div>
                    <div>業務：${truck.sellerName} <br> 電話：${truck.sellerContact}</div>
                </div>
            `;
            
            // 添加卡片點擊事件，顯示詳情
            card.addEventListener('click', () => {
                viewTruckDetail(truck.id);
            });
            
            return card;
        }
        
        // 篩選條件切換
        filterToggle.addEventListener('click', () => {
            filterContent.classList.toggle('show');
            filterToggle.querySelector('.toggle-icon').textContent = 
                filterContent.classList.contains('show') ? '▲' : '▼';
        });
        
        // 應用篩選條件
        document.getElementById('apply-filter').addEventListener('click', () => {
            // 收集所有篩選條件
            activeFilters = {
                keyword: document.getElementById('search-keyword').value,
                brand: document.getElementById('brand-filter').value,
                type: document.getElementById('type-filter').value,
                priceMin: document.getElementById('price-min').value,
                priceMax: document.getElementById('price-max').value,
                yearMin: document.getElementById('year-min').value,
                yearMax: document.getElementById('year-max').value,
                weight: document.getElementById('weight-filter').value,
                length: document.getElementById('length-filter').value,
                status: document.getElementById('status-filter').value,
                sortBy: document.getElementById('sort-by').value
            };
            
            // 重置分頁狀態
            lastVisibleTruck = null;
            
            // 載入篩選後的結果
            loadTrucks(true);
            
            // 收起篩選面板
            filterContent.classList.remove('show');
            filterToggle.querySelector('.toggle-icon').textContent = '▼';
        });
        
        // 無限滾動載入
        window.addEventListener('scroll', () => {
            if (homePage.classList.contains('active')) {
                const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
                
                if (scrollTop + clientHeight >= scrollHeight - 100 && !isLoadingMore) {
                    loadTrucks();
                }
            }
        });
        
        // ============ 車輛詳情功能 ============
        
        // 查看車輛詳情
        async function viewTruckDetail(truckId) {
            try {
                // 獲取車輛數據
                const doc = await db.collection('trucks').doc(truckId).get();
                
                if (!doc.exists) {
                    alert('找不到此車輛資訊');
                    return;
                }
                
                const truck = { id: doc.id, ...doc.data() };
                
                // 更新瀏覽次數
                db.collection('trucks').doc(truckId).update({
                    views: (truck.views || 0) + 1
                });
                
                // 品牌中文名稱對照
                const brandNames = {
                    'isuzu': '五十鈴',
                    'hino': '日野',
                    'fuso': '三菱扶桑',
                    'volvo': '富豪',
                    'scania': '斯堪尼亞',
                    'mercedes': '賓士',
                    'man': '曼恩',
                    'other': '其他'
                };
                
                // 車型中文名稱對照
                const typeNames = {
                    'flatbed': '平板車',
                    'dump': '砂石車',
                    'cargo': '貨櫃車',
                    'refrigerated': '冷凍車',
                    'tanker': '槽車',
                    'crane': '吊車',
                    'other': '其他'
                };
                
                // 車況評級中文
                const conditionNames = {
                    'excellent': '優良 (近乎全新)',
                    'good': '良好 (正常使用痕跡)',
                    'fair': '普通 (有些許問題但可正常使用)',
                    'poor': '較差 (需要維修)'
                };
                
                // 狀態中文
                let statusText = '';
                let statusClass = '';
                
                switch (truck.status) {
                    case 'available':
                        statusText = '可售';
                        statusClass = 'status-available';
                        break;
                    case 'pending':
                        statusText = '洽談中';
                        statusClass = 'status-pending';
                        break;
                    case 'sold':
                        statusText = '已售出';
                        statusClass = 'status-sold';
                        break;
                }
                
                // 圖片輪播HTML
                let sliderHTML = '';
                let sliderDotsHTML = '';
                
                if (truck.images && truck.images.length > 0) {
                    // 圖片容器
                    sliderHTML = '<div class="slider-container">';
                    
                    // 添加每張圖片
                    truck.images.forEach((image, index) => {
                        sliderHTML += `<img src="${image}" alt="車輛照片 ${index+1}" class="slider-image">`;
                        sliderDotsHTML += `<div class="slider-dot ${index === 0 ? 'active' : ''}" data-index="${index}"></div>`;
                    });
                    
                    sliderHTML += '</div><div class="slider-nav">' + sliderDotsHTML + '</div>';
                } else {
                    sliderHTML = '<img src="/api/placeholder/320/200" alt="無圖片" class="card-img">';
                }
                
                // 填充詳情頁內容
                truckDetail.innerHTML = `
                    <div class="card-status ${statusClass}" style="position: relative; top: auto; right: auto; display: inline-block; margin-bottom: 10px;">${statusText}</div>
                    <h2>${brandNames[truck.brand] || truck.brand} ${truck.model}</h2>
                    
                    <div class="image-slider">
                        ${sliderHTML}
                    </div>
                    
                    <div class="card mt-2">
                        <div class="card-content">
                            <div class="card-price">${truck.price} 萬元</div>
                            
                            <h3 class="mb-1">基本資訊</h3>
                            <table style="width: 100%; margin-bottom: 15px;">
                                <tr>
                                    <td style="width: 40%; font-weight: bold;">出廠年份</td>
                                    <td>${truck.year} 年</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">車型分類</td>
                                    <td>${typeNames[truck.type] || truck.type}</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">載重噸數</td>
                                    <td>${truck.weight} 噸</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">車身長度</td>
                                    <td>${truck.length} 呎</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">引擎規格</td>
                                    <td>${truck.engine || '未提供'}</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">車況評級</td>
                                    <td>${conditionNames[truck.condition] || truck.condition}</td>
                                </tr>
                            </table>
                            
                            <h3 class="mb-1">車輛描述</h3>
                            <p style="white-space: pre-line; margin-bottom: 15px;">${truck.description || '無描述'}</p>
                            
                            <h3 class="mb-1">業務聯絡方式</h3>
                            <p>負責人: ${truck.sellerName}</p>
                            <p>聯絡方式: ${truck.sellerContact}</p>
                            
                            <div class="mt-2">
                                <a href="tel:${truck.sellerContact}" class="btn btn-success btn-block">撥打電話</a>
                            </div>
                            
                            ${currentUser ? `
                                <div class="mt-1">
                                    <button class="btn btn-block" id="edit-truck-btn" data-id="${truck.id}">編輯車輛資訊</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                // 添加輪播功能
                if (truck.images && truck.images.length > 0) {
                    setupImageSlider();
                }
                
                // 添加編輯按鈕事件
                const editBtn = document.getElementById('edit-truck-btn');
                if (editBtn) {
                    editBtn.addEventListener('click', () => {
                        editTruck(truck.id);
                    });
                }
                
                // 顯示詳情頁
                showPage('detail-page');
                
            } catch (error) {
                console.error('載入車輛詳情失敗:', error);
                alert('載入車輛詳情失敗，請稍後再試');
            }
        }
        
        // 設置圖片輪播功能
        function setupImageSlider() {
            const sliderContainer = document.querySelector('.slider-container');
            const dots = document.querySelectorAll('.slider-dot');
            
            if (!sliderContainer || !dots.length) return;
            
            // 點擊圓點切換圖片
            dots.forEach(dot => {
                dot.addEventListener('click', () => {
                    const index = parseInt(dot.dataset.index);
                    sliderContainer.style.transform = `translateX(-${index * 100}%)`;
                    
                    // 更新活動點
                    dots.forEach(d => d.classList.remove('active'));
                    dot.classList.add('active');
                });
            });
            
            // 滑動功能
            let startX, endX;
            const threshold = 50; // 滑動閾值
            
            sliderContainer.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
            });
            
            sliderContainer.addEventListener('touchend', (e) => {
                endX = e.changedTouches[0].clientX;
                const diff = startX - endX;
                
                if (Math.abs(diff) < threshold) return;
                
                // 找出當前活動點
                const activeDot = document.querySelector('.slider-dot.active');
                const currentIndex = parseInt(activeDot.dataset.index);
                let newIndex;
                
                if (diff > 0 && currentIndex < dots.length - 1) {
                    // 向左滑動，顯示下一張
                    newIndex = currentIndex + 1;
                } else if (diff < 0 && currentIndex > 0) {
                    // 向右滑動，顯示上一張
                    newIndex = currentIndex - 1;
                } else {
                    return;
                }
                
                // 更新輪播位置
                sliderContainer.style.transform = `translateX(-${newIndex * 100}%)`;
                
                // 更新活動點
                dots.forEach(d => d.classList.remove('active'));
                dots[newIndex].classList.add('active');
            });
        }
        
        // 返回列表按鈕事件
        backToListBtn.addEventListener('click', () => {
            showPage('home-page');
        });
        
        // ============ 車輛新增/編輯功能 ============
        
        // 添加車輛按鈕事件
        addTruckBtn.addEventListener('click', () => {
            // 清空表單
            document.getElementById('truck-form').reset();
            document.getElementById('truck-id').value = '';
            document.getElementById('edit-title').textContent = '新增車輛';
            imagePreviews.innerHTML = '';
            editingImages = [];
            truckImages = [];
            
            // 顯示編輯頁面
            showPage('edit-page');
        });
        
        // 取消編輯按鈕事件
        cancelEditBtn.addEventListener('click', () => {
            // 返回前一頁
            window.history.back();
        });
        
        // 處理圖片上傳預覽
        truckImagesInput.addEventListener('change', (e) => {
            const files = e.target.files;
            
            // 清空預覽區域
            imagePreviews.innerHTML = '';
            truckImages = [];
            
            // 添加新選擇的檔案
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // 只接受圖片檔案
                if (!file.type.startsWith('image/')) continue;
                
                truckImages.push(file);
                
                // 創建預覽元素
                const preview = document.createElement('div');
                preview.className = 'image-preview';
                
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                
                const removeBtn = document.createElement('div');
                removeBtn.className = 'remove-image';
                removeBtn.innerHTML = '×';
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    // 從陣列中移除檔案
                    const index = truckImages.indexOf(file);
                    if (index > -1) {
                        truckImages.splice(index, 1);
                    }
                    
                    // 移除預覽元素
                    preview.remove();
                });
                
                preview.appendChild(img);
                preview.appendChild(removeBtn);
                imagePreviews.appendChild(preview);
            }
        });
        
        // 加載編輯的車輛資訊
        async function editTruck(truckId) {
            try {
                const doc = await db.collection('trucks').doc(truckId).get();
                
                if (!doc.exists) {
                    alert('找不到此車輛資訊');
                    return;
                }
                
                const truck = { id: doc.id, ...doc.data() };
                
                // 填充表單
                document.getElementById('truck-id').value = truck.id;
                document.getElementById('truck-brand').value = truck.brand;
                document.getElementById('truck-model').value = truck.model;
                document.getElementById('truck-type').value = truck.type;
                document.getElementById('truck-price').value = truck.price;
                document.getElementById('truck-year').value = truck.year;
                document.getElementById('truck-weight').value = truck.weight;
                document.getElementById('truck-length').value = truck.length;
                document.getElementById('truck-engine').value = truck.engine || '';
                document.getElementById('truck-condition').value = truck.condition;
                document.getElementById('truck-status').value = truck.status;
                document.getElementById('truck-description').value = truck.description || '';
                document.getElementById('seller-name').value = truck.sellerName;
                document.getElementById('seller-contact').value = truck.sellerContact;
                
                // 設置頁面標題
                document.getElementById('edit-title').textContent = '編輯車輛';
                
                // 清空圖片預覽
                imagePreviews.innerHTML = '';
                editingImages = truck.images || [];
                
                // 顯示現有圖片預覽
                if (editingImages.length > 0) {
                    editingImages.forEach((imageUrl, index) => {
                        const preview = document.createElement('div');
                        preview.className = 'image-preview';
                        
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        
                        const removeBtn = document.createElement('div');
                        removeBtn.className = 'remove-image';
                        removeBtn.innerHTML = '×';
                        removeBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            
                            // 從陣列中移除
                            editingImages.splice(index, 1);
                            
                            // 移除預覽元素
                            preview.remove();
                        });
                        
                        preview.appendChild(img);
                        preview.appendChild(removeBtn);
                        imagePreviews.appendChild(preview);
                    });
                }
                
                // 顯示編輯頁
                showPage('edit-page');
                
            } catch (error) {
                console.error('載入車輛編輯資訊失敗:', error);
                alert('載入車輛編輯資訊失敗，請稍後再試');
            }
        }
        
        // 表單提交處理
        truckForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // 顯示加載中提示
            const submitBtn = truckForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '儲存中...';
            submitBtn.disabled = true;
            
            try {
                // 獲取表單數據
                const truckId = document.getElementById('truck-id').value;
                const formData = {
                    brand: document.getElementById('truck-brand').value,
                    model: document.getElementById('truck-model').value,
                    type: document.getElementById('truck-type').value,
                    price: parseFloat(document.getElementById('truck-price').value),
                    year: parseInt(document.getElementById('truck-year').value),
                    weight: parseFloat(document.getElementById('truck-weight').value),
                    length: parseFloat(document.getElementById('truck-length').value),
                    engine: document.getElementById('truck-engine').value,
                    condition: document.getElementById('truck-condition').value,
                    status: document.getElementById('truck-status').value,
                    description: document.getElementById('truck-description').value,
                    sellerName: document.getElementById('seller-name').value,
                    sellerContact: document.getElementById('seller-contact').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // 上傳新圖片（如果有）
                let imageUrls = [...editingImages]; // 保留編輯時未刪除的原有圖片
                
                if (truckImages.length > 0) {
                    for (const file of truckImages) {
                        // 創建唯一的檔案名
                        const fileName = `trucks/${Date.now()}-${Math.random().toString(36).substring(2)}.${file.name.split('.').pop()}`;
                        
                        // 上傳到 Firebase Storage
                        const fileRef = storage.ref().child(fileName);
                        await fileRef.put(file);
                        
                        // 獲取下載 URL
                        const downloadUrl = await fileRef.getDownloadURL();
                        imageUrls.push(downloadUrl);
                    }
                }
                
                // 添加圖片URL到表單數據
                formData.images = imageUrls;
                
                // 保存到 Firestore
                if (truckId) {
                    // 更新現有車輛
                    await db.collection('trucks').doc(truckId).update(formData);
                } else {
                    // 添加新車輛
                    formData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    formData.views = 0;
                    await db.collection('trucks').add(formData);
                }
                
                // 成功處理
                alert(truckId ? '車輛資訊已更新' : '車輛已成功添加');
                
                // 重新載入
                loadTrucks(true);
                
                // 返回首頁
                showPage('home-page');
                
            } catch (error) {
                console.error('儲存車輛資訊失敗:', error);
                alert('儲存車輛資訊失敗，請稍後再試');
            } finally {
                // 恢復按鈕狀態
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });
        
        // ============ 用戶認證功能 (預留) ============
        
        // 監聽認證狀態變化
        auth.onAuthStateChanged(user => {
            currentUser = user;
            updateUIForAuth();
        });
        
        // 更新UI顯示登入狀態
        function updateUIForAuth() {
            if (currentUser) {
                // 用戶已登入
                document.querySelectorAll('.auth-only').forEach(el => {
                    el.style.display = 'block';
                });
                document.querySelectorAll('.non-auth').forEach(el => {
                    el.style.display = 'none';
                });
            } else {
                // 用戶未登入
                document.querySelectorAll('.auth-only').forEach(el => {
                    el.style.display = 'none';
                });
                document.querySelectorAll('.non-auth').forEach(el => {
                    el.style.display = 'block';
                });
            }
        }
        
        // 登入表單提交處理
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                showPage('home-page');
            } catch (error) {
                console.error('登入失敗:', error);
                alert('登入失敗: ' + error.message);
            }
        });
        
        // 註冊連結點擊事件 (預留功能)
        document.getElementById('register-link').addEventListener('click', (e) => {
            e.preventDefault();
            // 顯示註冊表單 (這裡可以擴展註冊功能)
            alert('註冊功能尚未開放，請聯絡管理員');
        });
        
        // ============ 離線功能 ============
        
        // 檢查是否支援 Service Worker
        if ('serviceWorker' in navigator && 'caches' in window) {
            // 註冊 Service Worker (需要另外實現 sw.js)
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('Service Worker 註冊成功:', registration);
                })
                .catch(error => {
                    console.error('Service Worker 註冊失敗:', error);
                });
                
            // 離線模式檢測
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            
            function updateOnlineStatus() {
                const isOnline = navigator.onLine;
                if (!isOnline) {
                    // 顯示離線提示
                    alert('您現在處於離線模式，部分功能可能受限');
                }
            }
        }
        
        // ============ 初始化應用 ============
        
        // 頁面載入完成後執行
        document.addEventListener('DOMContentLoaded', () => {
            // 載入車輛列表
            loadTrucks(true);
            
            // 初始化 UI
            updateUIForAuth();
        });
    </script>
</body>
</html>
