<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§è²¨è»Šæ¥­å‹™è³‡è¨Šå…±äº«ç³»çµ±</title>
    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-storage-compat.min.js"></script>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#3498db">
    
    <!-- CSS æ¨£å¼ -->
    <style>
        :root {
            /* é¡è‰²è®Šæ•¸ */
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --text-color: #333;
            --bg-color: #f9f9f9;
            --card-bg: #fff;
            --border-color: #ddd;
            
            /* å­—é«”è®Šæ•¸ */
            --font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', sans-serif;
            --font-size-sm: 0.875rem;
            --font-size-md: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-xxl: 1.5rem;
            
            /* é–“è·è®Šæ•¸ */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            
            /* é™°å½±è®Šæ•¸ */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --shadow-md: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
            --shadow-lg: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
            
            /* åœ“è§’è®Šæ•¸ */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 16px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: var(--font-family);
            font-size: var(--font-size-md);
            color: var(--text-color);
            background-color: var(--bg-color);
            line-height: 1.6;
            padding-bottom: 60px; /* ç‚ºåº•éƒ¨å°èˆªç•™å‡ºç©ºé–“ */
        }
        
        /* é é¢å®¹å™¨ */
        .container {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            padding: var(--spacing-md);
        }
        
        /* æ¨™é¡Œæ¨£å¼ */
        h1, h2, h3, h4, h5, h6 {
            color: var(--secondary-color);
            margin-bottom: var(--spacing-md);
        }
        
        h1 {
            font-size: var(--font-size-xxl);
            text-align: center;
        }
        
        h2 {
            font-size: var(--font-size-xl);
        }
        
        h3 {
            font-size: var(--font-size-lg);
        }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            display: inline-block;
            padding: var(--spacing-sm) var(--spacing-md);
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: var(--font-size-md);
            text-align: center;
            text-decoration: none;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        /* è¡¨å–®æ¨£å¼ */
        .form-group {
            margin-bottom: var(--spacing-md);
        }
        
        label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: bold;
        }
        
        input, select, textarea {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-family: var(--font-family);
            font-size: var(--font-size-md);
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-md);
            overflow: hidden;
            position: relative;
        }
        
        .card-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        
        .card-content {
            padding: var(--spacing-md);
        }
        
        .card-title {
            font-size: var(--font-size-lg);
            margin-bottom: var(--spacing-xs);
            color: var(--dark-color);
        }
        
        .card-price {
            font-size: var(--font-size-xl);
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: var(--spacing-xs);
        }
        
        .card-info {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-sm);
        }
        
        .card-info span {
            background: var(--light-color);
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
        }
        
        .card-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 3px 10px;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            font-weight: bold;
            color: white;
        }
        
        .status-available {
            background-color: var(--success-color);
        }
        
        .status-pending {
            background-color: var(--warning-color);
        }
        
        .status-sold {
            background-color: var(--danger-color);
        }
        
        /* æœå°‹éæ¿¾å€å¡Š */
        .filter-section {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-md);
        }
        
        .filter-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .filter-toggle h3 {
            margin-bottom: 0;
        }
        
        .filter-content {
            display: none;
            margin-top: var(--spacing-md);
        }
        
        .filter-content.show {
            display: block;
        }
        
        .filter-row {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
        }
        
        .filter-group {
            flex: 1;
        }
        
        /* å°èˆªæ¬„ */
        .navbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            padding: var(--spacing-xs) 0;
            z-index: 1000;
        }
        
        .nav-item {
            text-align: center;
            flex: 1;
            padding: var(--spacing-xs);
            color: var(--secondary-color);
            text-decoration: none;
            font-size: var(--font-size-sm);
        }
        
        .nav-item.active {
            color: var(--primary-color);
        }
        
        .nav-icon {
            font-size: 1.5rem;
            margin-bottom: 2px;
        }
        
        /* æ¨¡æ…‹è¦–çª— */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            overflow-y: auto;
        }
        
        .modal-content {
            background: white;
            margin: 20px auto;
            max-width: 480px;
            border-radius: var(--radius-md);
            overflow: hidden;
        }
        
        .modal-header {
            padding: var(--spacing-md);
            background: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: var(--spacing-md);
        }
        
        .modal-footer {
            padding: var(--spacing-md);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-md);
            border-top: 1px solid var(--border-color);
        }
        
        .close {
            font-size: 1.5rem;
            cursor: pointer;
            color: white;
        }
        
        /* è©³æƒ…é è»Šè¼›åœ–ç‰‡è¼ªæ’­ */
        .image-slider {
            position: relative;
            width: 100%;
            height: 250px;
            overflow: hidden;
        }
        
        .slider-container {
            display: flex;
            transition: transform 0.3s ease-in-out;
            height: 100%;
        }
        
        .slider-image {
            min-width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .slider-nav {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 8px;
        }
        
        .slider-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            cursor: pointer;
        }
        
        .slider-dot.active {
            background: white;
        }
        
        /* æ‡¸æµ®æ·»åŠ æŒ‰éˆ• */
        .fab {
            position: fixed;
            bottom: 70px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            box-shadow: var(--shadow-md);
            z-index: 900;
            cursor: pointer;
        }
        
        /* åœ–ç‰‡ä¸Šå‚³é è¦½å€åŸŸ */
        .image-upload {
            margin-bottom: var(--spacing-md);
        }
        
        .preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }
        
        .image-preview {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-sm);
            overflow: hidden;
            position: relative;
        }
        
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-image {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            background: rgba(0,0,0,0.5);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            cursor: pointer;
        }
        
        /* ç„¡é™æ»¾å‹•åŠ è¼‰æŒ‡ç¤ºå™¨ */
        .loading {
            text-align: center;
            padding: var(--spacing-md);
            display: none;
        }
        
        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (min-width: 768px) {
            .container {
                max-width: 720px;
            }
            
            .card-list {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: var(--spacing-md);
            }
        }
        
        /* é é¢åˆ‡æ›æ•ˆæœ */
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* å·¥å…·é¡ */
        .text-center {
            text-align: center;
        }
        
        .mb-1 {
            margin-bottom: var(--spacing-sm);
        }
        
        .mb-2 {
            margin-bottom: var(--spacing-md);
        }
        
        .mb-3 {
            margin-bottom: var(--spacing-lg);
        }
        
        .mt-1 {
            margin-top: var(--spacing-sm);
        }
        
        .mt-2 {
            margin-top: var(--spacing-md);
        }
        
        .mt-3 {
            margin-top: var(--spacing-lg);
        }
    </style>
</head>
<body>
    <!-- æ‡‰ç”¨ç¨‹å¼å®¹å™¨ -->
    <div id="app">
        <!-- è»Šè¼›åˆ—è¡¨é é¢ -->
        <div id="home-page" class="page active">
            <div class="container">
                <h1>å¤§è²¨è»Šè³‡è¨Šç³»çµ±</h1>
                
                <!-- æœå°‹éæ¿¾å€å¡Š -->
                <div class="filter-section">
                    <div class="filter-toggle" id="filterToggle">
                        <h3>æœå°‹èˆ‡ç¯©é¸</h3>
                        <span class="toggle-icon">â–¼</span>
                    </div>
                    <div class="filter-content" id="filterContent">
                        <!-- é—œéµå­—æœå°‹ -->
                        <div class="form-group mb-2">
                            <input type="text" id="search-keyword" placeholder="è¼¸å…¥é—œéµå­—æœå°‹...">
                        </div>
                        
                        <!-- æ¢ä»¶ç¯©é¸ -->
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="brand-filter">å» ç‰Œ</label>
                                <select id="brand-filter">
                                    <option value="">æ‰€æœ‰å» ç‰Œ</option>
                                    <option value="isuzu">äº”åéˆ´</option>
                                    <option value="hino">æ—¥é‡</option>
                                    <option value="fuso">ä¸‰è±æ‰¶æ¡‘</option>
                                    <option value="volvo">å¯Œè±ª</option>
                                    <option value="scania">æ–¯å ªå°¼äº</option>
                                    <option value="mercedes">è³“å£«</option>
                                    <option value="man">æ›¼æ©</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="type-filter">è»Šå‹</label>
                                <select id="type-filter">
                                    <option value="">æ‰€æœ‰è»Šå‹</option>
                                    <option value="flatbed">å¹³æ¿è»Š</option>
                                    <option value="dump">ç ‚çŸ³è»Š</option>
                                    <option value="cargo">è²¨æ«ƒè»Š</option>
                                    <option value="refrigerated">å†·å‡è»Š</option>
                                    <option value="tanker">æ§½è»Š</option>
                                    <option value="crane">åŠè»Š</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="price-min">åƒ¹æ ¼ç¯„åœ</label>
                                <div style="display: flex; gap: 8px;">
                                    <input type="number" id="price-min" placeholder="æœ€ä½åƒ¹">
                                    <input type="number" id="price-max" placeholder="æœ€é«˜åƒ¹">
                                </div>
                            </div>
                            <div class="filter-group">
                                <label for="year-min">å¹´ä»½ç¯„åœ</label>
                                <div style="display: flex; gap: 8px;">
                                    <input type="number" id="year-min" placeholder="æœ€èˆŠ">
                                    <input type="number" id="year-max" placeholder="æœ€æ–°">
                                </div>
                            </div>
                        </div>
                        
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="weight-filter">è¼‰é‡å™¸æ•¸</label>
                                <select id="weight-filter">
                                    <option value="">æ‰€æœ‰å™¸æ•¸</option>
                                    <option value="3.5">3.5å™¸ä»¥ä¸‹</option>
                                    <option value="5">5å™¸</option>
                                    <option value="8">8å™¸</option>
                                    <option value="10">10å™¸</option>
                                    <option value="15">15å™¸ä»¥ä¸Š</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="length-filter">è»Šèº«é•·åº¦</label>
                                <select id="length-filter">
                                    <option value="">æ‰€æœ‰é•·åº¦</option>
                                    <option value="14">14å‘</option>
                                    <option value="17">17å‘</option>
                                    <option value="20">20å‘</option>
                                    <option value="24">24å‘</option>
                                    <option value="35">35å‘ä»¥ä¸Š</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="sort-by">æ’åºæ–¹å¼</label>
                                <select id="sort-by">
                                    <option value="newest">æœ€æ–°ä¸Šæ¶</option>
                                    <option value="price-asc">åƒ¹æ ¼ç”±ä½è‡³é«˜</option>
                                    <option value="price-desc">åƒ¹æ ¼ç”±é«˜è‡³ä½</option>
                                    <option value="year-asc">å¹´ä»½ç”±èˆŠè‡³æ–°</option>
                                    <option value="year-desc">å¹´ä»½ç”±æ–°è‡³èˆŠ</option>
                                    <option value="popular">æœ€ç†±é–€</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="status-filter">è»Šè¼›ç‹€æ…‹</label>
                                <select id="status-filter">
                                    <option value="available">å¯å”®è»Šè¼›</option>
                                    <option value="all">å…¨éƒ¨è»Šè¼›</option>
                                    <option value="pending">æ´½è«‡ä¸­</option>
                                    <option value="sold">å·²å”®å‡º</option>
                                </select>
                            </div>
                        </div>
                        
                        <button class="btn btn-block mt-1" id="apply-filter">å¥—ç”¨ç¯©é¸</button>
                    </div>
                </div>
                
                <!-- è»Šè¼›åˆ—è¡¨ -->
                <div class="card-list" id="truck-list">
                    <!-- è»Šè¼›å¡ç‰‡æœƒé€éJavaScriptå‹•æ…‹ç”Ÿæˆ -->
                </div>
                
                <!-- åŠ è¼‰æŒ‡ç¤ºå™¨ -->
                <div class="loading" id="loading">
                    <p>è¼‰å…¥æ›´å¤šè»Šè¼›...</p>
                </div>
            </div>
            
            <!-- æ–°å¢è»Šè¼›æŒ‰éˆ• -->
            <div class="fab" id="add-truck-btn">+</div>
        </div>
        
        <!-- è»Šè¼›è©³æƒ…é é¢ -->
        <div id="detail-page" class="page">
            <div class="container">
                <div id="truck-detail">
                    <!-- è©³æƒ…å…§å®¹ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
                </div>
                <button class="btn btn-block mb-2" id="back-to-list">è¿”å›åˆ—è¡¨</button>
            </div>
        </div>
        
        <!-- æ–°å¢/ç·¨è¼¯è»Šè¼›é é¢ -->
        <div id="edit-page" class="page">
            <div class="container">
                <h1 id="edit-title">æ–°å¢è»Šè¼›</h1>
                <form id="truck-form">
                    <input type="hidden" id="truck-id">
                    
                    <div class="form-group">
                        <label for="truck-brand">å» ç‰Œ</label>
                        <select id="truck-brand" required>
                            <option value="">é¸æ“‡å» ç‰Œ</option>
                            <option value="isuzu">äº”åéˆ´</option>
                            <option value="hino">æ—¥é‡</option>
                            <option value="fuso">ä¸‰è±æ‰¶æ¡‘</option>
                            <option value="volvo">å¯Œè±ª</option>
                            <option value="scania">æ–¯å ªå°¼äº</option>
                            <option value="mercedes">è³“å£«</option>
                            <option value="man">æ›¼æ©</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-model">è»Šå‹åç¨±</label>
                        <input type="text" id="truck-model" required placeholder="ä¾‹ï¼šFUSO SUPER GREAT">
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-type">è»Šå‹åˆ†é¡</label>
                        <select id="truck-type" required>
                            <option value="">é¸æ“‡è»Šå‹</option>
                            <option value="flatbed">å¹³æ¿è»Š</option>
                            <option value="dump">ç ‚çŸ³è»Š</option>
                            <option value="cargo">è²¨æ«ƒè»Š</option>
                            <option value="refrigerated">å†·å‡è»Š</option>
                            <option value="tanker">æ§½è»Š</option>
                            <option value="crane">åŠè»Š</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-price">å”®åƒ¹ (è¬å…ƒ)</label>
                        <input type="number" id="truck-price" required min="0" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-year">å‡ºå» å¹´ä»½</label>
                        <input type="number" id="truck-year" required min="1980" max="2030">
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-weight">è¼‰é‡å™¸æ•¸</label>
                        <input type="number" id="truck-weight" required min="0" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-length">è»Šèº«é•·åº¦ (å‘)</label>
                        <input type="number" id="truck-length" required min="0" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-engine">å¼•æ“è¦æ ¼</label>
                        <input type="text" id="truck-engine" placeholder="ä¾‹ï¼š400åŒ¹/12800cc">
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-condition">è»Šæ³è©•ç´š</label>
                        <select id="truck-condition" required>
                            <option value="excellent">å„ªè‰¯ (è¿‘ä¹å…¨æ–°)</option>
                            <option value="good">è‰¯å¥½ (æ­£å¸¸ä½¿ç”¨ç—•è·¡)</option>
                            <option value="fair">æ™®é€š (æœ‰äº›è¨±å•é¡Œä½†å¯æ­£å¸¸ä½¿ç”¨)</option>
                            <option value="poor">è¼ƒå·® (éœ€è¦ç¶­ä¿®)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-status">éŠ·å”®ç‹€æ…‹</label>
                        <select id="truck-status" required>
                            <option value="available">å¯å”®</option>
                            <option value="pending">æ´½è«‡ä¸­</option>
                            <option value="sold">å·²å”®å‡º</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-description">è»Šè¼›æè¿°</label>
                        <textarea id="truck-description" rows="5" placeholder="è©³ç´°æè¿°è»Šè¼›ç‰¹é»ã€ä½¿ç”¨ç‹€æ³ã€ç‰¹æ®Šé…å‚™ç­‰..."></textarea>
                    </div>
                    
                    <div class="form-group image-upload">
                        <label>ä¸Šå‚³è»Šè¼›ç…§ç‰‡</label>
                        <input type="file" id="truck-images" multiple accept="image/*">
                        <div class="preview-container" id="image-previews"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="seller-name">è² è²¬æ¥­å‹™</label>
                        <input type="text" id="seller-name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="seller-contact">è¯çµ¡æ–¹å¼</label>
                        <input type="text" id="seller-contact" required placeholder="é›»è©±æˆ–LINE ID">
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-success btn-block">å„²å­˜è»Šè¼›è³‡è¨Š</button>
                    </div>
                    
                    <div class="form-group">
                        <button type="button" class="btn btn-block" id="cancel-edit">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- ç™»å…¥é é¢ï¼ˆé ç•™ï¼‰ -->
        <div id="login-page" class="page">
            <div class="container">
                <h1 class="mb-3">æ¥­å‹™ç™»å…¥</h1>
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-email">é›»å­éƒµä»¶</label>
                        <input type="email" id="login-email" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">å¯†ç¢¼</label>
                        <input type="password" id="login-password" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-success btn-block">ç™»å…¥</button>
                    </div>
                    <p class="text-center mt-2">
                        <a href="#" id="register-link">è¨»å†Šæ–°å¸³è™Ÿ</a>
                    </p>
                </form>
            </div>
        </div>

        <!-- å°èˆªæ¬„ -->
        <div class="navbar">
            <a href="#" class="nav-item active" data-page="home-page">
                <div class="nav-icon">ğŸ </div>
                <div>é¦–é </div>
            </a>
            <a href="#" class="nav-item" data-page="">
                <div class="nav-icon">ğŸ”</div>
                <div>æœå°‹</div>
            </a>
            <a href="#" class="nav-item" data-page="">
                <div class="nav-icon">ğŸ‘¤</div>
                <div>æˆ‘çš„</div>
            </a>
        </div>
    </div>

    <!-- JavaScriptä»£ç¢¼ -->
    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCujF5qmtk7Jhmxh0qPFUIActnEc8ysLgg",
            authDomain: "truck-sharing-system.firebaseapp.com",
            projectId: "truck-sharing-system",
            storageBucket: "truck-sharing-system.firebasestorage.app",
            messagingSenderId: "706717228220",
            appId: "1:706717228220:web:f50b2e5d3c9436817004b9",
            measurementId: "G-0PBEWXX6C0"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        const auth = firebase.auth();
        
        // é é¢å…ƒç´ å¼•ç”¨
        const homePage = document.getElementById('home-page');
        const detailPage = document.getElementById('detail-page');
        const editPage = document.getElementById('edit-page');
        const loginPage = document.getElementById('login-page');
        const truckList = document.getElementById('truck-list');
        const truckDetail = document.getElementById('truck-detail');
        const filterToggle = document.getElementById('filterToggle');
        const filterContent = document.getElementById('filterContent');
        const addTruckBtn = document.getElementById('add-truck-btn');
        const backToListBtn = document.getElementById('back-to-list');
        const truckForm = document.getElementById('truck-form');
        const cancelEditBtn = document.getElementById('cancel-edit');
        const imagePreviews = document.getElementById('image-previews');
        const truckImagesInput = document.getElementById('truck-images');
        const loadingIndicator = document.getElementById('loading');
        
        // å…¨å±€è®Šæ•¸
        let currentUser = null; // ç•¶å‰ç™»å…¥ç”¨æˆ¶
        let lastVisibleTruck = null; // åˆ†é åŠ è¼‰çš„æœ€å¾Œä¸€å€‹æ–‡æª”
        let isLoadingMore = false; // æ˜¯å¦æ­£åœ¨åŠ è¼‰æ›´å¤š
        let activeFilters = {}; // æ´»å‹•ç¯©é¸æ¢ä»¶
        let editingImages = []; // ç·¨è¼¯æ™‚çš„åœ–ç‰‡åˆ—è¡¨
        let truckImages = []; // ä¸Šå‚³çš„åœ–ç‰‡æª”æ¡ˆåˆ—è¡¨
        
        // ============ é é¢å°èˆªåŠŸèƒ½ ============
        
        // é¡¯ç¤ºç‰¹å®šé é¢
        function showPage(pageId) {
            // éš±è—æ‰€æœ‰é é¢
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // é¡¯ç¤ºæŒ‡å®šé é¢
            document.getElementById(pageId).classList.add('active');
            
            // æ›´æ–°å°èˆªæ¬„ç‹€æ…‹
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.dataset.page === pageId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        // å°èˆªæ¬„é»æ“Šè™•ç†
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const pageId = this.dataset.page;
                if (pageId) {
                    showPage(pageId);
                }
            });
        });
        
        // ============ è»Šè¼›åˆ—è¡¨åŠŸèƒ½ ============
        
        // è¼‰å…¥è»Šè¼›åˆ—è¡¨
        async function loadTrucks(isInitialLoad = false) {
            if (isLoadingMore) return;
            
            isLoadingMore = true;
            loadingIndicator.style.display = 'block';
            
            try {
                // å‰µå»ºåŸºç¤æŸ¥è©¢
                let query = db.collection('trucks');
                
                // æ‡‰ç”¨ç¯©é¸æ¢ä»¶
                if (activeFilters.status && activeFilters.status !== 'all') {
                    query = query.where('status', '==', activeFilters.status);
                }
                
                if (activeFilters.brand) {
                    query = query.where('brand', '==', activeFilters.brand);
                }
                
                if (activeFilters.type) {
                    query = query.where('type', '==', activeFilters.type);
                }
                
                // æ·»åŠ æ’åº
                switch (activeFilters.sortBy) {
                    case 'price-asc':
                        query = query.orderBy('price', 'asc');
                        break;
                    case 'price-desc':
                        query = query.orderBy('price', 'desc');
                        break;
                    case 'year-asc':
                        query = query.orderBy('year', 'asc');
                        break;
                    case 'year-desc':
                        query = query.orderBy('year', 'desc');
                        break;
                    case 'popular':
                        query = query.orderBy('views', 'desc');
                        break;
                    default:
                        query = query.orderBy('createdAt', 'desc'); // é»˜èªæŒ‰ä¸Šæ¶æ™‚é–“æ’åº
                }
                
                // åˆ†é è™•ç†
                if (!isInitialLoad && lastVisibleTruck) {
                    query = query.startAfter(lastVisibleTruck);
                }
                
                // é™åˆ¶æ¯æ¬¡åŠ è¼‰æ•¸é‡
                query = query.limit(10);
                
                // åŸ·è¡ŒæŸ¥è©¢
                const snapshots = await query.get();
                
                // æ¸…ç©ºåˆ—è¡¨ (å¦‚æœæ˜¯åˆå§‹è¼‰å…¥)
                if (isInitialLoad) {
                    truckList.innerHTML = '';
                }
                
                // æ›´æ–°æœ€å¾Œå¯è¦‹æ–‡æª”
                if (!snapshots.empty) {
                    lastVisibleTruck = snapshots.docs[snapshots.docs.length - 1];
                }
                
                if (snapshots.empty && isInitialLoad) {
                    truckList.innerHTML = '<p class="text-center">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è»Šè¼›</p>';
                    return;
                }
                
                // æ¸²æŸ“è»Šè¼›å¡ç‰‡
                snapshots.forEach(doc => {
                    const truck = { id: doc.id, ...doc.data() };
                    truckList.appendChild(createTruckCard(truck));
                });
                
            } catch (error) {
                console.error('è¼‰å…¥è»Šè¼›å¤±æ•—:', error);
                alert('è¼‰å…¥è»Šè¼›å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                isLoadingMore = false;
                loadingIndicator.style.display = 'none';
            }
        }
        
        // å‰µå»ºè»Šè¼›å¡ç‰‡å…ƒç´ 
        function createTruckCard(truck) {
            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.id = truck.id;
            
            // ç‹€æ…‹æ¨™ç±¤é¡åˆ¥
            let statusClass = '';
            let statusText = '';
            
            switch (truck.status) {
                case 'available':
                    statusClass = 'status-available';
                    statusText = 'å¯å”®';
                    break;
                case 'pending':
                    statusClass = 'status-pending';
                    statusText = 'æ´½è«‡ä¸­';
                    break;
                case 'sold':
                    statusClass = 'status-sold';
                    statusText = 'å·²å”®å‡º';
                    break;
            }
            
            // å“ç‰Œä¸­æ–‡åç¨±å°ç…§
            const brandNames = {
                'isuzu': 'äº”åéˆ´',
                'hino': 'æ—¥é‡',
                'fuso': 'ä¸‰è±æ‰¶æ¡‘',
                'volvo': 'å¯Œè±ª',
                'scania': 'æ–¯å ªå°¼äº',
                'mercedes': 'è³“å£«',
                'man': 'æ›¼æ©',
                'other': 'å…¶ä»–'
            };
            
            // è»Šå‹ä¸­æ–‡åç¨±å°ç…§
            const typeNames = {
                'flatbed': 'å¹³æ¿è»Š',
                'dump': 'ç ‚çŸ³è»Š',
                'cargo': 'è²¨æ«ƒè»Š',
                'refrigerated': 'å†·å‡è»Š',
                'tanker': 'æ§½è»Š',
                'crane': 'åŠè»Š',
                'other': 'å…¶ä»–'
            };
            
            // å¡«å……å¡ç‰‡å…§å®¹
            card.innerHTML = `
                <div class="card-status ${statusClass}">${statusText}</div>
                <img src="${truck.images && truck.images.length > 0 ? truck.images[0] : '/api/placeholder/320/200'}" alt="${truck.brand} ${truck.model}" class="card-img">
                <div class="card-content">
                    <div class="card-price">${truck.price} è¬å…ƒ</div>
                    <div class="card-title">${brandNames[truck.brand] || truck.brand} ${truck.model}</div>
                    <div class="card-info">
                        <span>${truck.year}å¹´</span>
                        <span>${typeNames[truck.type] || truck.type}</span>
                        <span>${truck.weight}å™¸</span>
                        <span>${truck.length}å‘</span>
                    </div>
                    <div>æ¥­å‹™ï¼š${truck.sellerName} <br> é›»è©±ï¼š${truck.sellerContact}</div>
                </div>
            `;
            
            // æ·»åŠ å¡ç‰‡é»æ“Šäº‹ä»¶ï¼Œé¡¯ç¤ºè©³æƒ…
            card.addEventListener('click', () => {
                viewTruckDetail(truck.id);
            });
            
            return card;
        }
        
        // ç¯©é¸æ¢ä»¶åˆ‡æ›
        filterToggle.addEventListener('click', () => {
            filterContent.classList.toggle('show');
            filterToggle.querySelector('.toggle-icon').textContent = 
                filterContent.classList.contains('show') ? 'â–²' : 'â–¼';
        });
        
        // æ‡‰ç”¨ç¯©é¸æ¢ä»¶
        document.getElementById('apply-filter').addEventListener('click', () => {
            // æ”¶é›†æ‰€æœ‰ç¯©é¸æ¢ä»¶
            activeFilters = {
                keyword: document.getElementById('search-keyword').value,
                brand: document.getElementById('brand-filter').value,
                type: document.getElementById('type-filter').value,
                priceMin: document.getElementById('price-min').value,
                priceMax: document.getElementById('price-max').value,
                yearMin: document.getElementById('year-min').value,
                yearMax: document.getElementById('year-max').value,
                weight: document.getElementById('weight-filter').value,
                length: document.getElementById('length-filter').value,
                status: document.getElementById('status-filter').value,
                sortBy: document.getElementById('sort-by').value
            };
            
            // é‡ç½®åˆ†é ç‹€æ…‹
            lastVisibleTruck = null;
            
            // è¼‰å…¥ç¯©é¸å¾Œçš„çµæœ
            loadTrucks(true);
            
            // æ”¶èµ·ç¯©é¸é¢æ¿
            filterContent.classList.remove('show');
            filterToggle.querySelector('.toggle-icon').textContent = 'â–¼';
        });
        
        // ç„¡é™æ»¾å‹•è¼‰å…¥
        window.addEventListener('scroll', () => {
            if (homePage.classList.contains('active')) {
                const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
                
                if (scrollTop + clientHeight >= scrollHeight - 100 && !isLoadingMore) {
                    loadTrucks();
                }
            }
        });
        
        // ============ è»Šè¼›è©³æƒ…åŠŸèƒ½ ============
        
        // æŸ¥çœ‹è»Šè¼›è©³æƒ…
        async function viewTruckDetail(truckId) {
            try {
                // ç²å–è»Šè¼›æ•¸æ“š
                const doc = await db.collection('trucks').doc(truckId).get();
                
                if (!doc.exists) {
                    alert('æ‰¾ä¸åˆ°æ­¤è»Šè¼›è³‡è¨Š');
                    return;
                }
                
                const truck = { id: doc.id, ...doc.data() };
                
                // æ›´æ–°ç€è¦½æ¬¡æ•¸
                db.collection('trucks').doc(truckId).update({
                    views: (truck.views || 0) + 1
                });
                
                // å“ç‰Œä¸­æ–‡åç¨±å°ç…§
                const brandNames = {
                    'isuzu': 'äº”åéˆ´',
                    'hino': 'æ—¥é‡',
                    'fuso': 'ä¸‰è±æ‰¶æ¡‘',
                    'volvo': 'å¯Œè±ª',
                    'scania': 'æ–¯å ªå°¼äº',
                    'mercedes': 'è³“å£«',
                    'man': 'æ›¼æ©',
                    'other': 'å…¶ä»–'
                };
                
                // è»Šå‹ä¸­æ–‡åç¨±å°ç…§
                const typeNames = {
                    'flatbed': 'å¹³æ¿è»Š',
                    'dump': 'ç ‚çŸ³è»Š',
                    'cargo': 'è²¨æ«ƒè»Š',
                    'refrigerated': 'å†·å‡è»Š',
                    'tanker': 'æ§½è»Š',
                    'crane': 'åŠè»Š',
                    'other': 'å…¶ä»–'
                };
                
                // è»Šæ³è©•ç´šä¸­æ–‡
                const conditionNames = {
                    'excellent': 'å„ªè‰¯ (è¿‘ä¹å…¨æ–°)',
                    'good': 'è‰¯å¥½ (æ­£å¸¸ä½¿ç”¨ç—•è·¡)',
                    'fair': 'æ™®é€š (æœ‰äº›è¨±å•é¡Œä½†å¯æ­£å¸¸ä½¿ç”¨)',
                    'poor': 'è¼ƒå·® (éœ€è¦ç¶­ä¿®)'
                };
                
                // ç‹€æ…‹ä¸­æ–‡
                let statusText = '';
                let statusClass = '';
                
                switch (truck.status) {
                    case 'available':
                        statusText = 'å¯å”®';
                        statusClass = 'status-available';
                        break;
                    case 'pending':
                        statusText = 'æ´½è«‡ä¸­';
                        statusClass = 'status-pending';
                        break;
                    case 'sold':
                        statusText = 'å·²å”®å‡º';
                        statusClass = 'status-sold';
                        break;
                }
                
                // åœ–ç‰‡è¼ªæ’­HTML
                let sliderHTML = '';
                let sliderDotsHTML = '';
                
                if (truck.images && truck.images.length > 0) {
                    // åœ–ç‰‡å®¹å™¨
                    sliderHTML = '<div class="slider-container">';
                    
                    // æ·»åŠ æ¯å¼µåœ–ç‰‡
                    truck.images.forEach((image, index) => {
                        sliderHTML += `<img src="${image}" alt="è»Šè¼›ç…§ç‰‡ ${index+1}" class="slider-image">`;
                        sliderDotsHTML += `<div class="slider-dot ${index === 0 ? 'active' : ''}" data-index="${index}"></div>`;
                    });
                    
                    sliderHTML += '</div><div class="slider-nav">' + sliderDotsHTML + '</div>';
                } else {
                    sliderHTML = '<img src="/api/placeholder/320/200" alt="ç„¡åœ–ç‰‡" class="card-img">';
                }
                
                // å¡«å……è©³æƒ…é å…§å®¹
                truckDetail.innerHTML = `
                    <div class="card-status ${statusClass}" style="position: relative; top: auto; right: auto; display: inline-block; margin-bottom: 10px;">${statusText}</div>
                    <h2>${brandNames[truck.brand] || truck.brand} ${truck.model}</h2>
                    
                    <div class="image-slider">
                        ${sliderHTML}
                    </div>
                    
                    <div class="card mt-2">
                        <div class="card-content">
                            <div class="card-price">${truck.price} è¬å…ƒ</div>
                            
                            <h3 class="mb-1">åŸºæœ¬è³‡è¨Š</h3>
                            <table style="width: 100%; margin-bottom: 15px;">
                                <tr>
                                    <td style="width: 40%; font-weight: bold;">å‡ºå» å¹´ä»½</td>
                                    <td>${truck.year} å¹´</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">è»Šå‹åˆ†é¡</td>
                                    <td>${typeNames[truck.type] || truck.type}</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">è¼‰é‡å™¸æ•¸</td>
                                    <td>${truck.weight} å™¸</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">è»Šèº«é•·åº¦</td>
                                    <td>${truck.length} å‘</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">å¼•æ“è¦æ ¼</td>
                                    <td>${truck.engine || 'æœªæä¾›'}</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">è»Šæ³è©•ç´š</td>
                                    <td>${conditionNames[truck.condition] || truck.condition}</td>
                                </tr>
                            </table>
                            
                            <h3 class="mb-1">è»Šè¼›æè¿°</h3>
                            <p style="white-space: pre-line; margin-bottom: 15px;">${truck.description || 'ç„¡æè¿°'}</p>
                            
                            <h3 class="mb-1">æ¥­å‹™è¯çµ¡æ–¹å¼</h3>
                            <p>è² è²¬äºº: ${truck.sellerName}</p>
                            <p>è¯çµ¡æ–¹å¼: ${truck.sellerContact}</p>
                            
                            <div class="mt-2">
                                <a href="tel:${truck.sellerContact}" class="btn btn-success btn-block">æ’¥æ‰“é›»è©±</a>
                            </div>
                            
                            ${currentUser ? `
                                <div class="mt-1">
                                    <button class="btn btn-block" id="edit-truck-btn" data-id="${truck.id}">ç·¨è¼¯è»Šè¼›è³‡è¨Š</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                // æ·»åŠ è¼ªæ’­åŠŸèƒ½
                if (truck.images && truck.images.length > 0) {
                    setupImageSlider();
                }
                
                // æ·»åŠ ç·¨è¼¯æŒ‰éˆ•äº‹ä»¶
                const editBtn = document.getElementById('edit-truck-btn');
                if (editBtn) {
                    editBtn.addEventListener('click', () => {
                        editTruck(truck.id);
                    });
                }
                
                // é¡¯ç¤ºè©³æƒ…é 
                showPage('detail-page');
                
            } catch (error) {
                console.error('è¼‰å…¥è»Šè¼›è©³æƒ…å¤±æ•—:', error);
                alert('è¼‰å…¥è»Šè¼›è©³æƒ…å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }
        
        // è¨­ç½®åœ–ç‰‡è¼ªæ’­åŠŸèƒ½
        function setupImageSlider() {
            const sliderContainer = document.querySelector('.slider-container');
            const dots = document.querySelectorAll('.slider-dot');
            
            if (!sliderContainer || !dots.length) return;
            
            // é»æ“Šåœ“é»åˆ‡æ›åœ–ç‰‡
            dots.forEach(dot => {
                dot.addEventListener('click', () => {
                    const index = parseInt(dot.dataset.index);
                    sliderContainer.style.transform = `translateX(-${index * 100}%)`;
                    
                    // æ›´æ–°æ´»å‹•é»
                    dots.forEach(d => d.classList.remove('active'));
                    dot.classList.add('active');
                });
            });
            
            // æ»‘å‹•åŠŸèƒ½
            let startX, endX;
            const threshold = 50; // æ»‘å‹•é–¾å€¼
            
            sliderContainer.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
            });
            
            sliderContainer.addEventListener('touchend', (e) => {
                endX = e.changedTouches[0].clientX;
                const diff = startX - endX;
                
                if (Math.abs(diff) < threshold) return;
                
                // æ‰¾å‡ºç•¶å‰æ´»å‹•é»
                const activeDot = document.querySelector('.slider-dot.active');
                const currentIndex = parseInt(activeDot.dataset.index);
                let newIndex;
                
                if (diff > 0 && currentIndex < dots.length - 1) {
                    // å‘å·¦æ»‘å‹•ï¼Œé¡¯ç¤ºä¸‹ä¸€å¼µ
                    newIndex = currentIndex + 1;
                } else if (diff < 0 && currentIndex > 0) {
                    // å‘å³æ»‘å‹•ï¼Œé¡¯ç¤ºä¸Šä¸€å¼µ
                    newIndex = currentIndex - 1;
                } else {
                    return;
                }
                
                // æ›´æ–°è¼ªæ’­ä½ç½®
                sliderContainer.style.transform = `translateX(-${newIndex * 100}%)`;
                
                // æ›´æ–°æ´»å‹•é»
                dots.forEach(d => d.classList.remove('active'));
                dots[newIndex].classList.add('active');
            });
        }
        
        // è¿”å›åˆ—è¡¨æŒ‰éˆ•äº‹ä»¶
        backToListBtn.addEventListener('click', () => {
            showPage('home-page');
        });
        
        // ============ è»Šè¼›æ–°å¢/ç·¨è¼¯åŠŸèƒ½ ============
        
        // æ·»åŠ è»Šè¼›æŒ‰éˆ•äº‹ä»¶
        addTruckBtn.addEventListener('click', () => {
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('truck-form').reset();
            document.getElementById('truck-id').value = '';
            document.getElementById('edit-title').textContent = 'æ–°å¢è»Šè¼›';
            imagePreviews.innerHTML = '';
            editingImages = [];
            truckImages = [];
            
            // é¡¯ç¤ºç·¨è¼¯é é¢
            showPage('edit-page');
        });
        
        // å–æ¶ˆç·¨è¼¯æŒ‰éˆ•äº‹ä»¶
        cancelEditBtn.addEventListener('click', () => {
            // è¿”å›å‰ä¸€é 
            window.history.back();
        });
        
        // è™•ç†åœ–ç‰‡ä¸Šå‚³é è¦½
        truckImagesInput.addEventListener('change', (e) => {
            const files = e.target.files;
            
            // æ¸…ç©ºé è¦½å€åŸŸ
            imagePreviews.innerHTML = '';
            truckImages = [];
            
            // æ·»åŠ æ–°é¸æ“‡çš„æª”æ¡ˆ
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // åªæ¥å—åœ–ç‰‡æª”æ¡ˆ
                if (!file.type.startsWith('image/')) continue;
                
                truckImages.push(file);
                
                // å‰µå»ºé è¦½å…ƒç´ 
                const preview = document.createElement('div');
                preview.className = 'image-preview';
                
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                
                const removeBtn = document.createElement('div');
                removeBtn.className = 'remove-image';
                removeBtn.innerHTML = 'Ã—';
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    // å¾é™£åˆ—ä¸­ç§»é™¤æª”æ¡ˆ
                    const index = truckImages.indexOf(file);
                    if (index > -1) {
                        truckImages.splice(index, 1);
                    }
                    
                    // ç§»é™¤é è¦½å…ƒç´ 
                    preview.remove();
                });
                
                preview.appendChild(img);
                preview.appendChild(removeBtn);
                imagePreviews.appendChild(preview);
            }
        });
        
        // åŠ è¼‰ç·¨è¼¯çš„è»Šè¼›è³‡è¨Š
        async function editTruck(truckId) {
            try {
                const doc = await db.collection('trucks').doc(truckId).get();
                
                if (!doc.exists) {
                    alert('æ‰¾ä¸åˆ°æ­¤è»Šè¼›è³‡è¨Š');
                    return;
                }
                
                const truck = { id: doc.id, ...doc.data() };
                
                // å¡«å……è¡¨å–®
                document.getElementById('truck-id').value = truck.id;
                document.getElementById('truck-brand').value = truck.brand;
                document.getElementById('truck-model').value = truck.model;
                document.getElementById('truck-type').value = truck.type;
                document.getElementById('truck-price').value = truck.price;
                document.getElementById('truck-year').value = truck.year;
                document.getElementById('truck-weight').value = truck.weight;
                document.getElementById('truck-length').value = truck.length;
                document.getElementById('truck-engine').value = truck.engine || '';
                document.getElementById('truck-condition').value = truck.condition;
                document.getElementById('truck-status').value = truck.status;
                document.getElementById('truck-description').value = truck.description || '';
                document.getElementById('seller-name').value = truck.sellerName;
                document.getElementById('seller-contact').value = truck.sellerContact;
                
                // è¨­ç½®é é¢æ¨™é¡Œ
                document.getElementById('edit-title').textContent = 'ç·¨è¼¯è»Šè¼›';
                
                // æ¸…ç©ºåœ–ç‰‡é è¦½
                imagePreviews.innerHTML = '';
                editingImages = truck.images || [];
                
                // é¡¯ç¤ºç¾æœ‰åœ–ç‰‡é è¦½
                if (editingImages.length > 0) {
                    editingImages.forEach((imageUrl, index) => {
                        const preview = document.createElement('div');
                        preview.className = 'image-preview';
                        
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        
                        const removeBtn = document.createElement('div');
                        removeBtn.className = 'remove-image';
                        removeBtn.innerHTML = 'Ã—';
                        removeBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            
                            // å¾é™£åˆ—ä¸­ç§»é™¤
                            editingImages.splice(index, 1);
                            
                            // ç§»é™¤é è¦½å…ƒç´ 
                            preview.remove();
                        });
                        
                        preview.appendChild(img);
                        preview.appendChild(removeBtn);
                        imagePreviews.appendChild(preview);
                    });
                }
                
                // é¡¯ç¤ºç·¨è¼¯é 
                showPage('edit-page');
                
            } catch (error) {
                console.error('è¼‰å…¥è»Šè¼›ç·¨è¼¯è³‡è¨Šå¤±æ•—:', error);
                alert('è¼‰å…¥è»Šè¼›ç·¨è¼¯è³‡è¨Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }
        
        // è¡¨å–®æäº¤è™•ç†
        truckForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // é¡¯ç¤ºåŠ è¼‰ä¸­æç¤º
            const submitBtn = truckForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'å„²å­˜ä¸­...';
            submitBtn.disabled = true;
            
            try {
                // ç²å–è¡¨å–®æ•¸æ“š
                const truckId = document.getElementById('truck-id').value;
                const formData = {
                    brand: document.getElementById('truck-brand').value,
                    model: document.getElementById('truck-model').value,
                    type: document.getElementById('truck-type').value,
                    price: parseFloat(document.getElementById('truck-price').value),
                    year: parseInt(document.getElementById('truck-year').value),
                    weight: parseFloat(document.getElementById('truck-weight').value),
                    length: parseFloat(document.getElementById('truck-length').value),
                    engine: document.getElementById('truck-engine').value,
                    condition: document.getElementById('truck-condition').value,
                    status: document.getElementById('truck-status').value,
                    description: document.getElementById('truck-description').value,
                    sellerName: document.getElementById('seller-name').value,
                    sellerContact: document.getElementById('seller-contact').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // ä¸Šå‚³æ–°åœ–ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰
                let imageUrls = [...editingImages]; // ä¿ç•™ç·¨è¼¯æ™‚æœªåˆªé™¤çš„åŸæœ‰åœ–ç‰‡
                
                if (truckImages.length > 0) {
                    for (const file of truckImages) {
                        // å‰µå»ºå”¯ä¸€çš„æª”æ¡ˆå
                        const fileName = `trucks/${Date.now()}-${Math.random().toString(36).substring(2)}.${file.name.split('.').pop()}`;
                        
                        // ä¸Šå‚³åˆ° Firebase Storage
                        const fileRef = storage.ref().child(fileName);
                        await fileRef.put(file);
                        
                        // ç²å–ä¸‹è¼‰ URL
                        const downloadUrl = await fileRef.getDownloadURL();
                        imageUrls.push(downloadUrl);
                    }
                }
                
                // æ·»åŠ åœ–ç‰‡URLåˆ°è¡¨å–®æ•¸æ“š
                formData.images = imageUrls;
                
                // ä¿å­˜åˆ° Firestore
                if (truckId) {
                    // æ›´æ–°ç¾æœ‰è»Šè¼›
                    await db.collection('trucks').doc(truckId).update(formData);
                } else {
                    // æ·»åŠ æ–°è»Šè¼›
                    formData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    formData.views = 0;
                    await db.collection('trucks').add(formData);
                }
                
                // æˆåŠŸè™•ç†
                alert(truckId ? 'è»Šè¼›è³‡è¨Šå·²æ›´æ–°' : 'è»Šè¼›å·²æˆåŠŸæ·»åŠ ');
                
                // é‡æ–°è¼‰å…¥
                loadTrucks(true);
                
                // è¿”å›é¦–é 
                showPage('home-page');
                
            } catch (error) {
                console.error('å„²å­˜è»Šè¼›è³‡è¨Šå¤±æ•—:', error);
                alert('å„²å­˜è»Šè¼›è³‡è¨Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });
        
        // ============ ç”¨æˆ¶èªè­‰åŠŸèƒ½ (é ç•™) ============
        
        // ç›£è½èªè­‰ç‹€æ…‹è®ŠåŒ–
        auth.onAuthStateChanged(user => {
            currentUser = user;
            updateUIForAuth();
        });
        
        // æ›´æ–°UIé¡¯ç¤ºç™»å…¥ç‹€æ…‹
        function updateUIForAuth() {
            if (currentUser) {
                // ç”¨æˆ¶å·²ç™»å…¥
                document.querySelectorAll('.auth-only').forEach(el => {
                    el.style.display = 'block';
                });
                document.querySelectorAll('.non-auth').forEach(el => {
                    el.style.display = 'none';
                });
            } else {
                // ç”¨æˆ¶æœªç™»å…¥
                document.querySelectorAll('.auth-only').forEach(el => {
                    el.style.display = 'none';
                });
                document.querySelectorAll('.non-auth').forEach(el => {
                    el.style.display = 'block';
                });
            }
        }
        
        // ç™»å…¥è¡¨å–®æäº¤è™•ç†
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                showPage('home-page');
            } catch (error) {
                console.error('ç™»å…¥å¤±æ•—:', error);
                alert('ç™»å…¥å¤±æ•—: ' + error.message);
            }
        });
        
        // è¨»å†Šé€£çµé»æ“Šäº‹ä»¶ (é ç•™åŠŸèƒ½)
        document.getElementById('register-link').addEventListener('click', (e) => {
            e.preventDefault();
            // é¡¯ç¤ºè¨»å†Šè¡¨å–® (é€™è£¡å¯ä»¥æ“´å±•è¨»å†ŠåŠŸèƒ½)
            alert('è¨»å†ŠåŠŸèƒ½å°šæœªé–‹æ”¾ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡');
        });
        
        // ============ é›¢ç·šåŠŸèƒ½ ============
        
        // æª¢æŸ¥æ˜¯å¦æ”¯æ´ Service Worker
        if ('serviceWorker' in navigator && 'caches' in window) {
            // è¨»å†Š Service Worker (éœ€è¦å¦å¤–å¯¦ç¾ sw.js)
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('Service Worker è¨»å†ŠæˆåŠŸ:', registration);
                })
                .catch(error => {
                    console.error('Service Worker è¨»å†Šå¤±æ•—:', error);
                });
                
            // é›¢ç·šæ¨¡å¼æª¢æ¸¬
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            
            function updateOnlineStatus() {
                const isOnline = navigator.onLine;
                if (!isOnline) {
                    // é¡¯ç¤ºé›¢ç·šæç¤º
                    alert('æ‚¨ç¾åœ¨è™•æ–¼é›¢ç·šæ¨¡å¼ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™');
                }
            }
        }
        
        // ============ åˆå§‹åŒ–æ‡‰ç”¨ ============
        
        // é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            // è¼‰å…¥è»Šè¼›åˆ—è¡¨
            loadTrucks(true);
            
            // åˆå§‹åŒ– UI
            updateUIForAuth();
        });
    </script>
</body>
</html>
