<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大貨車業務資訊共享系統</title>
    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-storage-compat.min.js"></script>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#3498db">
    
    <!-- CSS 樣式 -->
    <style>
        :root {
            /* 顏色變數 */
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --text-color: #333;
            --bg-color: #f9f9f9;
            --card-bg: #fff;
            --border-color: #ddd;
            
            /* 字體變數 */
            --font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', sans-serif;
            --font-size-sm: 0.875rem;
            --font-size-md: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-xxl: 1.5rem;
            
            /* 間距變數 */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            
            /* 陰影變數 */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --shadow-md: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
            --shadow-lg: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
            
            /* 圓角變數 */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 16px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: var(--font-family);
            font-size: var(--font-size-md);
            color: var(--text-color);
            background-color: var(--bg-color);
            line-height: 1.6;
            padding-bottom: 60px; /* 為底部導航留出空間 */
        }
        
        /* 頁面容器 */
        .container {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            padding: var(--spacing-md);
        }
        
        /* 標題樣式 */
        h1, h2, h3, h4, h5, h6 {
            color: var(--secondary-color);
            margin-bottom: var(--spacing-md);
        }
        
        h1 {
            font-size: var(--font-size-xxl);
            text-align: center;
        }
        
        h2 {
            font-size: var(--font-size-xl);
        }
        
        h3 {
            font-size: var(--font-size-lg);
        }
        
        /* 按鈕樣式 */
        .btn {
            display: inline-block;
            padding: var(--spacing-sm) var(--spacing-md);
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: var(--font-size-md);
            text-align: center;
            text-decoration: none;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        /* 表單樣式 */
        .form-group {
            margin-bottom: var(--spacing-md);
        }
        
        label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: bold;
        }
        
        input, select, textarea {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-family: var(--font-family);
            font-size: var(--font-size-md);
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        /* 卡片樣式 */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-md);
            overflow: hidden;
            position: relative;
        }
        
        .card-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        
        .card-content {
            padding: var(--spacing-md);
        }
        
        .card-title {
            font-size: var(--font-size-lg);
            margin-bottom: var(--spacing-xs);
            color: var(--dark-color);
        }
        
        .card-price {
            font-size: var(--font-size-xl);
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: var(--spacing-xs);
        }
        
        .card-info {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-sm);
        }
        
        .card-info span {
            background: var(--light-color);
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
        }
        
        .card-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 3px 10px;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            font-weight: bold;
            color: white;
        }
        
        .status-available {
            background-color: var(--success-color);
        }
        
        .status-pending {
            background-color: var(--warning-color);
        }
        
        .status-sold {
            background-color: var(--danger-color);
        }
        
        /* 搜尋過濾區塊 */
        .filter-section {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-md);
        }
        
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }

        .filter-content {
            padding: var(--spacing-md);
            display: block; /* 始終顯示 */
        }
        
        .filter-content.show {
            display: block;
        }
        
        .filter-row {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
        }
        
        .filter-group {
            flex: 1;
        }
        
        .navbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            padding: 8px 0; /* 降低高度 */
            z-index: 1000;
        }

        .nav-item {
            text-align: center;
            flex: 1;
            padding: 4px; /* 減少內邊距 */
            color: var(--secondary-color);
            text-decoration: none;
            font-size: var(--font-size-sm);
        }
        
        .nav-item.active {
            color: var(--primary-color);
        }
        
        /* 模態視窗 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            overflow-y: auto;
        }
        
        .modal-content {
            background: white;
            margin: 20px auto;
            max-width: 480px;
            border-radius: var(--radius-md);
            overflow: hidden;
        }
        
        .modal-header {
            padding: var(--spacing-md);
            background: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: var(--spacing-md);
        }
        
        .modal-footer {
            padding: var(--spacing-md);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-md);
            border-top: 1px solid var(--border-color);
        }
        
        .close {
            font-size: 1.5rem;
            cursor: pointer;
            color: white;
        }
        
        /* 詳情頁車輛圖片輪播 */
        .image-slider {
            position: relative;
            width: 100%;
            height: 250px;
            overflow: hidden;
        }
        
        .slider-container {
            display: flex;
            transition: transform 0.3s ease-in-out;
            height: 100%;
        }
        
        .slider-image {
            min-width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .slider-nav {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 8px;
        }
        
        .slider-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            cursor: pointer;
        }
        
        .slider-dot.active {
            background: white;
        }

        /* 詳情頁圖片查看按鈕 */
        .slider-image-wrapper {
            position: relative;
            height: 100%;
            min-width: 100%;
        }

        .fullscreen-button {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background: rgba(0,0,0,0.5);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 20px;
        }

        .fullscreen-button:hover {
            background: var(--primary-color);
        }
        
        /* 懸浮添加按鈕 */
        .fab {
            position: fixed;
            bottom: 70px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            box-shadow: var(--shadow-md);
            z-index: 900;
            cursor: pointer;
        }
        
        /* 圖片上傳預覽區域 */
        .image-upload {
            margin-bottom: var(--spacing-md);
        }
        
        .preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }
        
        .image-preview {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-sm);
            overflow: hidden;
            position: relative;
        }
        
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-image {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            background: rgba(0,0,0,0.5);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            cursor: pointer;
        }
        
        /* 無限滾動加載指示器 */
        .loading {
            text-align: center;
            padding: var(--spacing-md);
            display: none;
        }

        /* 分頁控制樣式 */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--spacing-md);
            margin: var(--spacing-md) 0;
        }

        .truck-count-display {
            text-align: center;
            font-weight: bold;
            font-size: var(--font-size-md);
        }
        
        /* 響應式調整 */
        @media (min-width: 768px) {
            .container {
                max-width: 720px;
            }
            
            .card-list {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: var(--spacing-md);
            }
        }
        
        /* 頁面切換效果 */
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* 工具類 */
        .text-center {
            text-align: center;
        }
        
        .mb-1 {
            margin-bottom: var(--spacing-sm);
        }
        
        .mb-2 {
            margin-bottom: var(--spacing-md);
        }
        
        .mb-3 {
            margin-bottom: var(--spacing-lg);
        }
        
        .mt-1 {
            margin-top: var(--spacing-sm);
        }
        
        .mt-2 {
            margin-top: var(--spacing-md);
        }
        
        .mt-3 {
            margin-top: var(--spacing-lg);
        }

        /* 搜尋頁面樣式 */
        .search-form {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        /* 全屏圖片查看相關樣式 */
        .fullscreen-slider-container {
            width: 100%;
            height: calc(100vh - 150px);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fullscreen-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
        }

        .fullscreen-slider-nav {
            display: flex;
            justify-content: center;
            padding: 10px 0;
            background: rgba(0,0,0,0.5);
            position: absolute;
            bottom: 0;
            width: 100%;
        }

        .fullscreen-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            margin: 0 5px;
            cursor: pointer;
        }

        .fullscreen-dot.active {
            background: white;
        }

        .zoom-controls {
            position: absolute;
            bottom: 15px;
            right: 15px;
            display: flex;
            gap: 5px;
        }

        .zoom-controls button {
            background: rgba(0,0,0,0.5);
            color: white;
            border: 1px solid white;
            padding: 5px 10px;
            font-size: 12px;
        }

        /* 圖片排序拖曳樣式 */
        .image-preview.dragging {
            opacity: 0.5;
            border: 2px dashed var(--primary-color);
        }

        .image-preview {
            cursor: move;
            position: relative;
        }

        .main-image-badge {
            position: absolute;
            top: 0;
            left: 0;
            background: var(--primary-color);
            color: white;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 0 0 var(--radius-sm) 0;
        }

        .set-main-image {
            position: absolute;
            bottom: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: rgba(0,0,0,0.5);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            cursor: pointer;
        }

        .set-main-image:hover {
            background: var(--primary-color);
        }

    </style>
</head>
<body>
    <!-- 應用程式容器 -->
    <div id="app">
        <!-- 車輛列表頁面 -->
        <div id="home-page" class="page active">
            <div class="container">
                <h1>大貨車資訊系統</h1>
                
                <!-- 篩選區塊 -->
                <div class="filter-section">
                    <div class="filter-header">
                        <h3>篩選</h3>
                    </div>
                    <div class="filter-content show" id="filterContent">
                        
                        <!-- 條件篩選 -->
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="brand-filter">廠牌</label>
                                <select id="brand-filter">
                                    <option value="">所有廠牌</option>
                                    <option value="isuzu">五十鈴 ISUZU</option>
                                    <option value="hino">日野 HINO</option>
                                    <option value="fuso">三菱扶桑 FUSO</option>
                                    <option value="volvo">富豪 VOLVO</option>
                                    <option value="scania">斯堪尼亞 SCANIA</option>
                                    <option value="mercedes">賓士 MERCEDES</option>
                                    <option value="man">曼恩 MAN</option>
                                    <option value="daf">達富 DAF</option>
                                    <option value="iveco">依維柯 IVECO</option>
                                    <option value="sitrak">賽德卡 SITRAK</option>
                                    <option value="ud">優迪 UD</option>
                                    <option value="other">其他 OTHER</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="type-filter">車型</label>
                                <select id="type-filter">
                                    <option value="">所有車型</option>
                                    <option value="flatbed">平板車</option>
                                    <option value="dump">砂石車</option>
                                    <option value="tanker">罐槽車</option>
                                    <option value="refrigerated">冷凍車</option>
                                    <option value="tractor">曳引車</option>
                                    <option value="crane">吊桿車</option>
                                    <option value="cargo">貨櫃車</option>
                                    <option value="box">框式車</option>
                                    <option value="concrete">混凝土預拌車</option>
                                    <option value="water">灑水車</option>
                                    <option value="other">其他</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="price-min">價格範圍</label>
                                <div style="display: flex; gap: 8px;">
                                    <input type="number" id="price-min" placeholder="最低價">
                                    <input type="number" id="price-max" placeholder="最高價">
                                </div>
                            </div>
                            <div class="filter-group">
                                <label for="year-min">年份範圍</label>
                                <div style="display: flex; gap: 8px;">
                                    <input type="number" id="year-min" placeholder="最舊">
                                    <input type="number" id="year-max" placeholder="最新">
                                </div>
                            </div>
                        </div>
                        
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="weight-filter">載重噸數</label>
                                <select id="weight-filter">
                                    <option value="">所有噸數</option>
                                    <option value="3.5">3.5噸以下</option>
                                    <option value="5">5噸</option>
                                    <option value="8">8噸</option>
                                    <option value="10">10噸</option>
                                    <option value="15">15噸以上</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="length-filter">車身長度</label>
                                <select id="length-filter">
                                    <option value="">所有長度</option>
                                    <option value="14">14呎</option>
                                    <option value="17">17呎</option>
                                    <option value="20">20呎</option>
                                    <option value="24">24呎</option>
                                    <option value="35">35呎以上</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="sort-by">排序方式</label>
                                <select id="sort-by">
                                    <option value="newest">最新上架</option>
                                    <option value="price-asc">價格由低至高</option>
                                    <option value="price-desc">價格由高至低</option>
                                    <option value="year-asc">年份由舊至新</option>
                                    <option value="year-desc">年份由新至舊</option>
                                    <option value="popular">最熱門</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="status-filter">車輛狀態</label>
                                <select id="status-filter">
                                    <option value="available">可售車輛</option>
                                    <option value="all">全部車輛</option>
                                    <option value="pending">洽談中</option>
                                    <option value="sold">已售出</option>
                                </select>
                            </div>
                        </div>
                        
                        <button class="btn btn-block mt-1" id="apply-filter">套用篩選</button>
                    </div>
                </div>
                
                <!-- 車輛列表 -->
                <div class="card-list" id="truck-list">
                    <!-- 車輛卡片會透過JavaScript動態生成 -->
                </div>
                
                <!-- 車輛數量顯示 -->
                <div class="truck-count-display mb-2 mt-2" id="truck-count">
                    <p>共有 <span id="total-trucks">0</span> 台車輛銷售中</p>
                </div>

                <!-- 分頁控制 -->
                <div class="pagination" id="pagination">
                    <button id="prev-page" class="btn">上一頁</button>
                    <span id="page-info">第 <span id="current-page">1</span> 頁，共 <span id="total-pages">1</span> 頁</span>
                    <button id="next-page" class="btn">下一頁</button>
                </div>
            </div>
            
            <!-- 新增車輛按鈕 -->
            <div class="fab auth-only" id="add-truck-btn">+</div>
        </div>
        
        <!-- 車輛詳情頁面 -->
        <div id="detail-page" class="page">
            <div class="container">
                <div id="truck-detail">
                    <!-- 詳情內容由JavaScript動態生成 -->
                </div>
                <button class="btn btn-block mb-2" id="back-to-list">返回列表</button>
            </div>
        </div>
        
        <!-- 新增/編輯車輛頁面 -->
        <div id="edit-page" class="page">
            <div class="container">
                <h1 id="edit-title">新增車輛</h1>
                <form id="truck-form">
                    <input type="hidden" id="truck-id">
                    
                    <div class="form-group">
                        <label for="truck-brand">廠牌</label>
                        <select id="truck-brand" required>
                            <option value="">選擇廠牌</option>
                            <option value="isuzu">五十鈴 ISUZU</option>
                            <option value="hino">日野 HINO</option>
                            <option value="fuso">三菱扶桑 FUSO</option>
                            <option value="volvo">富豪 VOLVO</option>
                            <option value="scania">斯堪尼亞 SCANIA</option>
                            <option value="mercedes">賓士 MERCEDES</option>
                            <option value="man">曼恩 MAN</option>
                            <option value="daf">達富 DAF</option>
                            <option value="iveco">依維柯 IVECO</option>
                            <option value="sitrak">賽德卡 SITRAK</option>
                            <option value="ud">優迪 UD</option>
                            <option value="other">其他 OTHER</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-model">車型名稱</label>
                        <input type="text" id="truck-model" required placeholder="例：Volvo FH">
                    </div>
                    
                    <div class="form-group">
                        <div class="form-group">
                            <label for="truck-type">車型分類</label>
                            <select id="truck-type" required>
                                <option value="">選擇車型</option>
                                <option value="flatbed">平板車</option>
                                <option value="dump">砂石車</option>
                                <option value="tanker">罐槽車</option>
                                <option value="refrigerated">冷凍車</option>
                                <option value="tractor">曳引車</option>
                                <option value="crane">吊桿車</option>
                                <option value="cargo">貨櫃車</option>
                                <option value="box">框式車</option>
                                <option value="concrete">混凝土預拌車</option>
                                <option value="water">灑水車</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="tailgate-lift">加裝尾門</label>
                        <select id="tailgate-lift" required>
                            <option value="none" selected>無尾門</option>
                            <option value="folding">折疊尾門</option>
                            <option value="flipup">掀起式尾門</option>
                            <option value="slide">滑入式尾門</option>
                            <option value="column">柱式尾門</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-price">售價 (萬元)</label>
                        <input type="number" id="truck-price" required min="0" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-year">出廠年份</label>
                        <select id="truck-year" required>
                            <option value="">選擇年份</option>
                            <!-- 年份選項將由JavaScript生成 -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="emission-phase">環保期數(Phase)</label>
                        <select id="emission-phase" required>
                            <option value="">選擇環保期數</option>
                            <option value="phase1">一期 1993年前</option>
                            <option value="phase2">二期 1993~1999</option>
                            <option value="phase3">三期 1999~2006</option>
                            <option value="phase4">四期 2006~2012</option>
                            <option value="phase5">五期 2013~2021</option>
                            <option value="phase6">六期 2021年後</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-weight">載重噸數</label>
                        <input type="number" id="truck-weight" required min="0" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-length">車身長度 (呎)</label>
                        <input type="number" id="truck-length" required min="0" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-engine">引擎規格</label>
                        <input type="text" id="truck-engine" placeholder="例：400匹/12800cc">
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-condition">車況評級</label>
                        <select id="truck-condition" required>
                            <option value="excellent">優良 (近乎全新)</option>
                            <option value="good">良好 (正常使用痕跡)</option>
                            <option value="fair">普通 (有些許問題但可正常使用)</option>
                            <option value="poor">較差 (需要維修)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-status">銷售狀態</label>
                        <select id="truck-status" required>
                            <option value="available">可售</option>
                            <option value="pending">洽談中</option>
                            <option value="sold">已售出</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="truck-description">車輛描述</label>
                        <textarea id="truck-description" rows="5" placeholder="詳細描述車輛特點、使用狀況、特殊配備等..."></textarea>
                    </div>
                    
                    <div class="form-group image-upload">
                        <label>上傳車輛照片</label>
                        <input type="file" id="truck-images" multiple accept="image/*">
                        <div class="preview-container" id="image-previews"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="seller-name">負責業務</label>
                        <input type="text" id="seller-name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="seller-contact">聯絡方式</label>
                        <input type="text" id="seller-contact" required placeholder="電話或LINE ID">
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-success btn-block">儲存車輛資訊</button>
                    </div>
                    
                    <div class="form-group">
                        <button type="button" class="btn btn-block" id="cancel-edit">取消</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 登入頁面（預留） -->
        <div id="login-page" class="page">
            <div class="container">
                <h1 class="mb-3">業務登入</h1>
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-email">電子郵件</label>
                        <input type="email" id="login-email" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">密碼</label>
                        <input type="password" id="login-password" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-success btn-block">登入</button>
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-block" id="forgot-password-btn">忘記密碼</button>
                    </div>
                    <p class="text-center mt-2">
                        <a href="#" id="register-link">註冊新帳號</a>
                    </p>
                </form>
            </div>
        </div>

        <!-- 註冊頁面 -->
        <div id="register-page" class="page">
            <div class="container">
                <h1 class="mb-3">註冊新帳號</h1>
                <form id="register-form">
                    <div class="form-group">
                        <label for="register-email">電子郵件</label>
                        <input type="email" id="register-email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="register-region">所屬地區</label>
                        <select id="register-region" required>
                            <option value="">選擇地區</option>
                            <option value="headquarter">總公司</option>
                            <option value="north">北區</option>
                            <option value="central">中區</option>
                            <option value="south">南區</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="register-department">所屬科別</label>
                        <select id="register-department" required disabled>
                            <option value="">請先選擇地區</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="register-name">業務姓名</label>
                        <input type="text" id="register-name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="register-employee-id">員工編號</label>
                        <input type="text" id="register-employee-id" pattern="[0-9]{4,5}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="register-extension">公司分機</label>
                        <input type="tel" id="register-extension" pattern="[0-9]*" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="register-phone">個人手機</label>
                        <input type="tel" id="register-phone" pattern="[0-9]*" required>
                    </div>

                    <div class="form-group">
                        <label for="register-line-id">LINE ID (選填)</label>
                        <input type="text" id="register-line-id" placeholder="請輸入您的LINE ID">
                    </div>
                    
                    <div class="form-group">
                        <label for="register-company-email">公司信箱</label>
                        <div style="display: flex;">
                            <input type="text" id="register-company-email" placeholder="username" style="flex: 1;">
                            <span style="padding: 8px 0; align-self: center;">@chailease.com.tw</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="register-introduction">個人簡介 (選填，150字)</label>
                        <textarea id="register-introduction" maxlength="150" rows="3" placeholder="簡單介紹自己負責的業務區域和特長"></textarea>
                        <div class="text-right">
                            <small><span id="intro-char-count">0</span>/150</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-success btn-block">註冊帳號</button>
                    </div>
                    
                    <div class="form-group">
                        <button type="button" class="btn btn-block" id="back-to-login">返回登入</button>
                    </div>
                </form>
                <div id="register-message" class="mt-2 text-center"></div>
            </div>
        </div>

        <!-- 業務個人資料頁面 -->
        <div id="profile-page" class="page">
            <div class="container">
                <h1 class="mb-3">業務資料</h1>
                <!-- 原有的個人資料卡片 -->
                <div class="card mb-3">
                    <div class="card-content">
                        <div id="user-profile">
                            <!-- 用戶資料會動態生成 -->
                        </div>
                        
                        <!-- 新增編輯按鈕 -->
                        <div class="form-group mt-2">
                            <button type="button" class="btn btn-block" id="edit-profile-btn">編輯個人資料</button>
                        </div>
                        
                        <div class="form-group mt-2">
                            <button type="button" class="btn btn-danger btn-block" id="logout-btn">登出帳號</button>
                        </div>
                    </div>
                </div>
                
                <!-- 新增簡化版的統計卡片 -->
                <div class="card">
                    <div class="card-content">
                        <h3 class="mb-1">同事最新上架</h3>
                        <div id="latest-trucks">
                            <p class="text-center">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 我的車輛列表卡片 -->
                <div class="card">
                    <div class="card-content">
                        <h3 class="mb-1">我的車輛</h3>
                        <div id="my-trucks-list">
                            <p class="text-center">載入中...</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        
        <!-- 新增編輯個人資料頁面 -->
        <div id="edit-profile-page" class="page">
            <div class="container">
                <h1 class="mb-3">編輯個人資料</h1>
                <form id="edit-profile-form">

                    <!-- 新增頭像上傳區域 -->
                    <div class="form-group text-center">
                        <div style="margin-bottom: 10px;">
                            <img id="profile-avatar-preview" src="/api/placeholder/100/100" alt="頭像" 
                                style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;">
                        </div>
                        <label for="profile-avatar" class="btn">更換頭像</label>
                        <input type="file" id="profile-avatar" accept="image/*" style="display: none;">
                    </div>

                    <div class="form-group">
                        <label for="edit-name">業務姓名</label>
                        <input type="text" id="edit-name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-phone">個人手機</label>
                        <input type="tel" id="edit-phone" pattern="[0-9]*" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-extension">公司分機</label>
                        <input type="tel" id="edit-extension" pattern="[0-9]*" required>
                    </div>

                    <div class="form-group">
                        <label for="edit-line-id">LINE ID (選填)</label>
                        <input type="text" id="edit-line-id" placeholder="請輸入您的LINE ID">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-company-email">公司信箱</label>
                        <div style="display: flex;">
                            <input type="text" id="edit-company-email" placeholder="username" style="flex: 1;">
                            <span style="padding: 8px 0; align-self: center;">@chailease.com.tw</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="edit-introduction">個人簡介 (選填，150字)</label>
                        <textarea id="edit-introduction" maxlength="150" rows="3" placeholder="簡單介紹自己負責的業務區域和特長"></textarea>
                        <div class="text-right">
                            <small><span id="edit-intro-char-count">0</span>/150</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-success btn-block">儲存變更</button>
                    </div>
                    
                    <div class="form-group">
                        <button type="button" class="btn btn-block" id="cancel-edit-profile">取消</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 搜尋頁面 -->
        <div id="search-page" class="page">
            <div class="container">
                <h1>車輛搜尋</h1>
                
                <!-- 搜尋表單 -->
                <div class="search-form mb-3">
                    <div class="form-group">
                        <input type="text" id="search-input" placeholder="輸入關鍵字..." class="mb-1">
                        <button id="search-button" class="btn btn-success btn-block">找車</button>
                    </div>
                </div>
                
                <!-- 搜尋結果數量顯示 -->
                <div id="search-result-count" class="mb-2" style="display: none;">
                    找到 <span id="result-count">0</span> 台符合的車輛
                </div>
                
                <!-- 搜尋結果列表 -->
                <div class="card-list" id="search-results">
                    <!-- 搜尋結果將在這裡顯示 -->
                </div>
            </div>
        </div>

        <!-- 忘記密碼模態視窗 -->
        <div id="forgot-password-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>忘記密碼</h3>
                    <span class="close" id="close-forgot-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <p>請輸入您註冊時使用的電子郵件地址，我們將發送重設密碼的連結。</p>
                    <p class="mb-2">重設連結將在24小時內有效，請及時查收並點擊郵件中的連結設定新密碼。</p>
                    <div class="form-group">
                        <label for="reset-email">電子郵件</label>
                        <input type="email" id="reset-email" required>
                    </div>
                    <div id="reset-message"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="send-reset-btn">發送重設連結</button>
                    <button type="button" class="btn" id="cancel-reset-btn">取消</button>
                </div>
            </div>
        </div>

        <!-- 註冊成功模態視窗 -->
        <div id="register-success-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>註冊成功</h3>
                    <span class="close" id="close-register-success-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <p>您的帳號已經成功註冊！</p>
                    <p>首次開通密碼已發送到您的電子郵件，請查收後登入系統。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="go-to-login-btn">前往登入</button>
                </div>
            </div>
        </div>

        <!-- 導航欄 -->
        <div class="navbar">
            <a href="#" class="nav-item active" data-page="home-page">
                <div>銷售中</div>
            </a>
            <a href="#" class="nav-item" id="search-nav-btn">
                <div>搜尋</div>
            </a>
            <a href="#" class="nav-item" id="discussion-nav-btn">
                <div>討論</div>
            </a>
            <a href="#" class="nav-item" data-page="login-page" id="profile-nav-btn">
                <div>業務</div>
            </a>
        </div>
    </div>

    <!-- JavaScript代碼 -->
    <script>
        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyCujF5qmtk7Jhmxh0qPFUIActnEc8ysLgg",
            authDomain: "truck-sharing-system.firebaseapp.com",
            projectId: "truck-sharing-system",
            storageBucket: "truck-sharing-system.firebasestorage.app",
            messagingSenderId: "706717228220",
            appId: "1:706717228220:web:f50b2e5d3c9436817004b9",
            measurementId: "G-0PBEWXX6C0"
        };

        // 在此位置添加圖片壓縮函數
        // 圖片壓縮函數
        async function compressImage(file, maxWidth = 1200, maxHeight = 1200, quality = 0.8) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function(event) {
                    const img = new Image();
                    img.src = event.target.result;
                    
                    img.onload = function() {
                        // 計算尺寸
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }
                        
                        // 創建canvas進行壓縮
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // 轉為blob
                        canvas.toBlob((blob) => {
                            // 創建新的File對象
                            const compressedFile = new File([blob], file.name, {
                                type: 'image/jpeg',
                                lastModified: Date.now()
                            });
                            
                            resolve(compressedFile);
                        }, 'image/jpeg', quality);
                    };
                };
            });
        }

        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        const auth = firebase.auth();
        
        // 頁面元素引用
        const homePage = document.getElementById('home-page');
        const detailPage = document.getElementById('detail-page');
        const editPage = document.getElementById('edit-page');
        const loginPage = document.getElementById('login-page');
        const truckList = document.getElementById('truck-list');
        const truckDetail = document.getElementById('truck-detail');
        const filterToggle = document.getElementById('filterToggle');
        const filterContent = document.getElementById('filterContent');
        const addTruckBtn = document.getElementById('add-truck-btn');
        const backToListBtn = document.getElementById('back-to-list');
        const truckForm = document.getElementById('truck-form');
        const cancelEditBtn = document.getElementById('cancel-edit');
        const imagePreviews = document.getElementById('image-previews');
        const truckImagesInput = document.getElementById('truck-images');
        const loadingIndicator = document.getElementById('loading');
        
        // 全局變數
        let currentUser = null; // 當前登入用戶
        let lastVisibleTruck = null; // 分頁加載的最後一個文檔
        let isLoadingMore = false; // 是否正在加載更多
        let activeFilters = {}; // 活動篩選條件
        let editingImages = []; // 編輯時的圖片列表
        let truckImages = []; // 上傳的圖片檔案列表

        // 添加分頁相關變數
        let currentPage = 1;
        let totalPages = 1;
        let trucksPerPage = 20;
        let allTrucks = []; // 存儲所有加載的車輛
        
        // ============ 頁面導航功能 ============
        
        // 顯示特定頁面
        function showPage(pageId) {
            // 隱藏所有頁面
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // 顯示指定頁面
            document.getElementById(pageId).classList.add('active');
            
            // 更新導航欄狀態
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.dataset.page === pageId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        // 導航欄點擊處理
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const pageId = this.dataset.page;
                if (pageId) {
                    showPage(pageId);
                }
            });
        });

        // 搜尋按鈕點擊處理
        document.getElementById('search-nav-btn').addEventListener('click', function(e) {
            e.preventDefault();
            showPage('search-page');
            // 清空搜尋結果
            document.getElementById('search-results').innerHTML = '';
            document.getElementById('search-result-count').style.display = 'none';
            document.getElementById('search-input').value = '';
            document.getElementById('search-input').focus();
        });

        // 搜尋功能
        document.getElementById('search-button').addEventListener('click', async function() {
            const keyword = document.getElementById('search-input').value.trim();
            
            if (!keyword) {
                alert('請輸入搜尋關鍵字');
                return;
            }
            
            try {
                // 顯示加載中
                document.getElementById('search-results').innerHTML = '<p class="text-center">搜尋中...</p>';
                
                // 從資料庫獲取所有車輛
                const querySnapshot = await db.collection('trucks').get();
                const allTrucks = querySnapshot.docs.map(doc => {
                    return { id: doc.id, ...doc.data() };
                });
                
                // 在前端進行關鍵字過濾
                const results = allTrucks.filter(truck => {
                    const searchText = (
                        (truck.brand || '') + ' ' +
                        (truck.model || '') + ' ' +
                        (truck.description || '') + ' ' +
                        (truck.sellerName || '')
                    ).toLowerCase();
                    
                    return searchText.includes(keyword.toLowerCase());
                });
                
                // 顯示結果數量
                document.getElementById('result-count').textContent = results.length;
                document.getElementById('search-result-count').style.display = 'block';
                
                // 清空並顯示結果
                const searchResults = document.getElementById('search-results');
                searchResults.innerHTML = '';
                
                if (results.length === 0) {
                    searchResults.innerHTML = '<p class="text-center">沒有找到符合的車輛</p>';
                } else {
                    // 渲染車輛卡片
                    results.forEach(truck => {
                        searchResults.appendChild(createTruckCard(truck));
                    });
                }
                
            } catch (error) {
                console.error('搜尋失敗:', error);
                document.getElementById('search-results').innerHTML = '<p class="text-center">搜尋失敗，請稍後再試</p>';
            }
        });

        // 搜尋輸入框按 Enter 鍵也觸發搜尋
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('search-button').click();
            }
        });

        // 分頁按鈕事件處理
        document.getElementById('prev-page').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                loadTrucks();
                // 滾動到頁面頂部
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });

        document.getElementById('next-page').addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                loadTrucks();
                // 滾動到頁面頂部
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });

        // 討論按鈕點擊處理
        document.getElementById('discussion-nav-btn').addEventListener('click', function(e) {
            e.preventDefault();
            alert('討論功能即將推出，敬請期待！');
        });
        
        // ============ 車輛列表功能 ============
        
        // 載入車輛列表
        async function loadTrucks(isInitialLoad = false) {
            if (isLoadingMore) return;
            
            isLoadingMore = true;
            
            try {
                // 創建基礎查詢
                let query = db.collection('trucks');
                
                // 應用篩選條件
                if (activeFilters.status && activeFilters.status !== 'all') {
                    query = query.where('status', '==', activeFilters.status);
                }

                if (activeFilters.brand) {
                    query = query.where('brand', '==', activeFilters.brand);
                }

                if (activeFilters.type) {
                    query = query.where('type', '==', activeFilters.type);
                }

                // 獲取所有符合條件的文檔
                let querySnapshot = await query.get();
                let filteredDocs = querySnapshot.docs;

                // 對於 Firestore 不支援的複合查詢，在前端進行篩選
                if (activeFilters.priceMin || activeFilters.priceMax || 
                    activeFilters.yearMin || activeFilters.yearMax || 
                    activeFilters.weight || activeFilters.length || 
                    activeFilters.keyword || activeFilters.sellerEmail) {
                    
                    filteredDocs = filteredDocs.filter(doc => {
                        const data = doc.data();
                        
                        // 價格範圍篩選
                        if (activeFilters.priceMin && data.price < parseFloat(activeFilters.priceMin)) return false;
                        if (activeFilters.priceMax && data.price > parseFloat(activeFilters.priceMax)) return false;
                        
                        // 年份範圍篩選
                        if (activeFilters.yearMin && data.year < parseInt(activeFilters.yearMin)) return false;
                        if (activeFilters.yearMax && data.year > parseInt(activeFilters.yearMax)) return false;
                        
                        // 載重篩選
                        if (activeFilters.weight && data.weight < parseFloat(activeFilters.weight)) return false;
                        
                        // 車身長度篩選
                        if (activeFilters.length && data.length < parseFloat(activeFilters.length)) return false;
                        
                        // 關鍵字搜尋 (搜尋品牌、型號、描述等多個欄位)
                        if (activeFilters.keyword) {
                            const keyword = activeFilters.keyword.toLowerCase();
                            const searchText = (
                                (data.brand || '') + ' ' +
                                (data.model || '') + ' ' +
                                (data.description || '') + ' ' +
                                (data.sellerName || '')
                            ).toLowerCase();
                            
                            if (!searchText.includes(keyword)) return false;
                        }

                        // 按業務郵箱篩選
                        if (activeFilters.sellerEmail && data.sellerEmail !== activeFilters.sellerEmail) return false;
                        
                        return true;
                    });
                }

                // 存儲所有符合條件的車輛
                allTrucks = filteredDocs.map(doc => {
                    return { id: doc.id, ...doc.data() };
                });
                
                // 計算總頁數
                totalPages = Math.ceil(allTrucks.length / trucksPerPage);
                if (totalPages === 0) totalPages = 1;
                
                // 如果是初始加載或重新篩選，重置為第一頁
                if (isInitialLoad) {
                    currentPage = 1;
                }
                
                // 確保頁碼在有效範圍內
                if (currentPage > totalPages) {
                    currentPage = totalPages;
                }
                
                // 更新頁面信息顯示
                document.getElementById('current-page').textContent = currentPage;
                document.getElementById('total-pages').textContent = totalPages;
                document.getElementById('total-trucks').textContent = allTrucks.length;
                
                // 計算當前頁的車輛
                const startIndex = (currentPage - 1) * trucksPerPage;
                const endIndex = Math.min(startIndex + trucksPerPage, allTrucks.length);
                const currentPageTrucks = allTrucks.slice(startIndex, endIndex);

                // 清空列表
                truckList.innerHTML = '';

                // 檢查是否有符合條件的車輛
                if (currentPageTrucks.length === 0) {
                    truckList.innerHTML = '<p class="text-center">沒有符合條件的車輛</p>';
                } else {
                    // 渲染車輛卡片
                    currentPageTrucks.forEach(truck => {
                        truckList.appendChild(createTruckCard(truck));
                    });
                }
                
                // 更新分頁按鈕狀態
                document.getElementById('prev-page').disabled = currentPage <= 1;
                document.getElementById('next-page').disabled = currentPage >= totalPages;
                
            } catch (error) {
                console.error('載入車輛失敗:', error);
                alert('載入車輛失敗，請稍後再試');
            } finally {
                isLoadingMore = false;
            }
        }
        
        // 創建車輛卡片元素
        function createTruckCard(truck) {
            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.id = truck.id;
            
            // 狀態標籤類別
            let statusClass = '';
            let statusText = '';
            
            switch (truck.status) {
                case 'available':
                    statusClass = 'status-available';
                    statusText = '可售';
                    break;
                case 'pending':
                    statusClass = 'status-pending';
                    statusText = '洽談中';
                    break;
                case 'sold':
                    statusClass = 'status-sold';
                    statusText = '已售出';
                    break;
            }
            
            // 品牌中文名稱對照
            const brandNames = {
                'isuzu': '五十鈴',
                'hino': '日野',
                'fuso': '三菱扶桑',
                'volvo': '富豪',
                'scania': '斯堪尼亞',
                'mercedes': '賓士',
                'man': '曼恩',
                'other': '其他'
            };
            
            // 車型中文名稱對照
            const typeNames = {
                'flatbed': '平板車',
                'dump': '砂石車',
                'cargo': '貨櫃車',
                'refrigerated': '冷凍車',
                'tanker': '槽車',
                'crane': '吊車',
                'other': '其他'
            };
            
            // 填充卡片內容
            card.innerHTML = `
                <div class="card-status ${statusClass}">${statusText}</div>
                <img src="${truck.images && truck.images.length > 0 ? truck.images[0] : '/api/placeholder/320/200'}" alt="${truck.brand} ${truck.model}" class="card-img">
                <div class="card-content">
                    <div class="card-price">${truck.price} 萬元</div>
                    <div class="card-title">${brandNames[truck.brand] || truck.brand} ${truck.model}</div>
                    <div class="card-info">
                        <span>${truck.year}年</span>
                        <span>${typeNames[truck.type] || truck.type}</span>
                        <span>${truck.weight}噸</span>
                        <span>${truck.length}呎</span>
                    </div>
                    <div>業務：${truck.sellerName} <br> 電話：${truck.sellerContact}</div>
                </div>
            `;
            
            // 添加卡片點擊事件，顯示詳情
            card.addEventListener('click', () => {
                viewTruckDetail(truck.id);
            });
            
            return card;
        }

        // 獲取尾門類型的顯示名稱
        function getTailgateLiftName(value) {
            const tailgateLiftNames = {
                'none': '無尾門',
                'folding': '折疊尾門',
                'flipup': '掀起式尾門',
                'slide': '滑入式尾門',
                'column': '柱式尾門'
            };
            return tailgateLiftNames[value] || value;
        }

        // 獲取環保期數的顯示名稱
        function getEmissionPhaseName(value) {
            const emissionPhaseNames = {
                'phase1': '一期 1993年前',
                'phase2': '二期 1993~1999',
                'phase3': '三期 1999~2006',
                'phase4': '四期 2006~2012',
                'phase5': '五期 2013~2021',
                'phase6': '六期 2021年後'
            };
            return emissionPhaseNames[value] || value;
        }
        
        // 應用篩選條件
        document.getElementById('apply-filter').addEventListener('click', () => {
            // 收集所有篩選條件（移除 keyword）
            activeFilters = {
                brand: document.getElementById('brand-filter').value,
                type: document.getElementById('type-filter').value,
                priceMin: document.getElementById('price-min').value,
                priceMax: document.getElementById('price-max').value,
                yearMin: document.getElementById('year-min').value,
                yearMax: document.getElementById('year-max').value,
                weight: document.getElementById('weight-filter').value,
                length: document.getElementById('length-filter').value,
                status: document.getElementById('status-filter').value,
                sortBy: document.getElementById('sort-by').value
            };
            
            // 載入篩選後的結果
            loadTrucks(true);
        });
        
        // ============ 車輛詳情功能 ============
        
        // 查看車輛詳情
        async function viewTruckDetail(truckId) {
            try {
                // 獲取車輛數據
                const doc = await db.collection('trucks').doc(truckId).get();
                
                if (!doc.exists) {
                    alert('找不到此車輛資訊');
                    return;
                }
                
                const truck = { id: doc.id, ...doc.data() };
                
                // 更新瀏覽次數
                db.collection('trucks').doc(truckId).update({
                    views: (truck.views || 0) + 1
                });
                
                // 品牌中文名稱對照
                const brandNames = {
                    'isuzu': '五十鈴 ISUZU',
                    'hino': '日野 HINO',
                    'fuso': '三菱扶桑 FUSO',
                    'volvo': '富豪 VOLVO',
                    'scania': '斯堪尼亞 SCANIA',
                    'mercedes': '賓士 MERCEDES',
                    'man': '曼恩 MAN',
                    'daf': '達富 DAF',
                    'iveco': '依維柯 IVECO',
                    'sitrak': '賽德卡 SITRAK',
                    'ud': '優迪 UD',
                    'other': '其他 OTHER'
                };

                // 車型中文名稱對照
                const typeNames = {
                    'flatbed': '平板車',
                    'dump': '砂石車',
                    'tanker': '罐槽車',
                    'refrigerated': '冷凍車',
                    'tractor': '曳引車',
                    'crane': '吊桿車',
                    'cargo': '貨櫃車',
                    'box': '框式車',
                    'concrete': '混凝土預拌車',
                    'water': '灑水車',
                    'other': '其他'
                };
                
                // 車況評級中文
                const conditionNames = {
                    'excellent': '優良 (近乎全新)',
                    'good': '良好 (正常使用痕跡)',
                    'fair': '普通 (有些許問題但可正常使用)',
                    'poor': '較差 (需要維修)'
                };
                
                // 狀態中文
                let statusText = '';
                let statusClass = '';
                
                switch (truck.status) {
                    case 'available':
                        statusText = '可售';
                        statusClass = 'status-available';
                        break;
                    case 'pending':
                        statusText = '洽談中';
                        statusClass = 'status-pending';
                        break;
                    case 'sold':
                        statusText = '已售出';
                        statusClass = 'status-sold';
                        break;
                }
                
                // 圖片輪播HTML
                let sliderHTML = '';
                let sliderDotsHTML = '';

                if (truck.images && truck.images.length > 0) {
                    // 圖片容器
                    sliderHTML = '<div class="slider-container">';
                    
                    // 添加每張圖片
                    truck.images.forEach((image, index) => {
                        sliderHTML += `
                            <div class="slider-image-wrapper">
                                <img src="${image}" alt="車輛照片 ${index+1}" class="slider-image">
                                <div class="fullscreen-button" data-index="${index}">
                                    <span>&#x26F6;</span>
                                </div>
                            </div>
                        `;
                        sliderDotsHTML += `<div class="slider-dot ${index === 0 ? 'active' : ''}" data-index="${index}"></div>`;
                    });
                    
                    sliderHTML += '</div><div class="slider-nav">' + sliderDotsHTML + '</div>';
                } else {
                    sliderHTML = '<img src="/api/placeholder/320/200" alt="無圖片" class="card-img">';
                }
                
                // 填充詳情頁內容
                truckDetail.innerHTML = `
                    <div class="card-status ${statusClass}" style="position: relative; top: auto; right: auto; display: inline-block; margin-bottom: 10px;">${statusText}</div>
                    <h2>${brandNames[truck.brand] || truck.brand} ${truck.model}</h2>
                    
                    <div class="image-slider">
                        ${sliderHTML}
                    </div>
                    
                    <div class="card mt-2">
                        <div class="card-content">
                            <div class="card-price">${truck.price} 萬元</div>
                            
                            <h3 class="mb-1">基本資訊</h3>
                            <table style="width: 100%; margin-bottom: 15px;">
                                <tr>
                                    <td style="width: 40%; font-weight: bold;">出廠年份</td>
                                    <td>${truck.year} 年</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">車型分類</td>
                                    <td>${typeNames[truck.type] || truck.type}</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">加裝尾門</td>
                                    <td>${getTailgateLiftName(truck.tailgateLift) || '無'}</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">環保期數</td>
                                    <td>${getEmissionPhaseName(truck.emissionPhase) || '未提供'}</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">載重噸數</td>
                                    <td>${truck.weight} 噸</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">車身長度</td>
                                    <td>${truck.length} 呎</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">引擎規格</td>
                                    <td>${truck.engine || '未提供'}</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">車況評級</td>
                                    <td>${conditionNames[truck.condition] || truck.condition}</td>
                                </tr>
                            </table>
                            
                            <h3 class="mb-1">車輛描述</h3>
                            <p style="white-space: pre-line; margin-bottom: 15px;">${truck.description || '無描述'}</p>
                            
                            <h3 class="mb-1">業務聯絡方式</h3>
                            <p>負責人: ${truck.sellerName}</p>
                            <p>聯絡方式: ${truck.sellerContact}</p>
                            
                            <div class="mt-2">
                                <a href="tel:${truck.sellerContact}" class="btn btn-success btn-block">撥打電話</a>
                            </div>
                            
                            ${currentUser ? `
                                <div class="mt-1">
                                    <button class="btn btn-block" id="edit-truck-btn" data-id="${truck.id}">編輯車輛資訊</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                // 添加輪播功能
                if (truck.images && truck.images.length > 0) {
                    setupImageSlider();
                }
                
                // 添加編輯按鈕事件
                const editBtn = document.getElementById('edit-truck-btn');
                if (editBtn) {
                    editBtn.addEventListener('click', () => {
                        editTruck(truck.id);
                    });
                }
                
                // 顯示詳情頁
                showPage('detail-page');
                
            } catch (error) {
                console.error('載入車輛詳情失敗:', error);
                alert('載入車輛詳情失敗，請稍後再試');
            }
        }
        
        // 設置圖片輪播功能
        function setupImageSlider() {
            const sliderContainer = document.querySelector('.slider-container');
            const dots = document.querySelectorAll('.slider-dot');
            
            if (!sliderContainer || !dots.length) return;
            
            // 點擊圓點切換圖片
            dots.forEach(dot => {
                dot.addEventListener('click', () => {
                    const index = parseInt(dot.dataset.index);
                    sliderContainer.style.transform = `translateX(-${index * 100}%)`;
                    
                    // 更新活動點
                    dots.forEach(d => d.classList.remove('active'));
                    dot.classList.add('active');
                });
            });
            
            // 滑動功能
            let startX, endX;
            const threshold = 50; // 滑動閾值
            
            sliderContainer.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
            });
            
            sliderContainer.addEventListener('touchend', (e) => {
                endX = e.changedTouches[0].clientX;
                const diff = startX - endX;
                
                if (Math.abs(diff) < threshold) return;
                
                // 找出當前活動點
                const activeDot = document.querySelector('.slider-dot.active');
                const currentIndex = parseInt(activeDot.dataset.index);
                let newIndex;
                
                if (diff > 0 && currentIndex < dots.length - 1) {
                    // 向左滑動，顯示下一張
                    newIndex = currentIndex + 1;
                } else if (diff < 0 && currentIndex > 0) {
                    // 向右滑動，顯示上一張
                    newIndex = currentIndex - 1;
                } else {
                    return;
                }
                
                // 更新輪播位置
                sliderContainer.style.transform = `translateX(-${newIndex * 100}%)`;
                
                // 更新活動點
                dots.forEach(d => d.classList.remove('active'));
                dots[newIndex].classList.add('active');
            });

            // 添加全屏查看功能
            const fullscreenButtons = document.querySelectorAll('.fullscreen-button');
            fullscreenButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(button.dataset.index);
                    
                    const modal = document.getElementById('fullscreen-image-modal');
                    const container = modal.querySelector('.fullscreen-slider-container');
                    const nav = modal.querySelector('.fullscreen-slider-nav');
                    
                    // 清空容器
                    container.innerHTML = '';
                    nav.innerHTML = '';
                    
                    // 當前縮放等級
                    let currentZoom = 1;
                    
                    // 添加圖片
                    truck.images.forEach((imageUrl, i) => {
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.className = 'fullscreen-image';
                        img.style.display = i === index ? 'block' : 'none';
                        img.dataset.index = i;
                        container.appendChild(img);
                        
                        // 添加導航點
                        const dot = document.createElement('div');
                        dot.className = `fullscreen-dot ${i === index ? 'active' : ''}`;
                        dot.dataset.index = i;
                        dot.addEventListener('click', () => {
                            // 重置縮放
                            currentZoom = 1;
                            resetZoom();
                            
                            // 切換圖片
                            container.querySelectorAll('.fullscreen-image').forEach(img => {
                                img.style.display = 'none';
                            });
                            container.querySelector(`.fullscreen-image[data-index="${i}"]`).style.display = 'block';
                            
                            // 更新導航點
                            nav.querySelectorAll('.fullscreen-dot').forEach(d => {
                                d.classList.remove('active');
                            });
                            dot.classList.add('active');
                        });
                        nav.appendChild(dot);
                    });
                    
                    // 綁定縮放按鈕
                    document.getElementById('zoom-in').onclick = () => {
                        currentZoom += 0.2;
                        updateZoom();
                    };
                    
                    document.getElementById('zoom-out').onclick = () => {
                        currentZoom = Math.max(0.5, currentZoom - 0.2);
                        updateZoom();
                    };
                    
                    document.getElementById('zoom-reset').onclick = () => {
                        currentZoom = 1;
                        resetZoom();
                    };
                    
                    function updateZoom() {
                        const currentImg = container.querySelector('.fullscreen-image[style*="display: block"]');
                        if (currentImg) {
                            currentImg.style.transform = `scale(${currentZoom})`;
                        }
                    }
                    
                    function resetZoom() {
                        container.querySelectorAll('.fullscreen-image').forEach(img => {
                            img.style.transform = `scale(1)`;
                        });
                    }
                    
                    // 顯示模態窗口
                    modal.style.display = 'block';
                });
            });

        }
        
        // 返回列表按鈕事件
        backToListBtn.addEventListener('click', () => {
            showPage('home-page');
        });
        
        // ============ 車輛新增/編輯功能 ============
        
        // 添加車輛按鈕事件
        addTruckBtn.addEventListener('click', () => {
            // 清空表單
            document.getElementById('truck-form').reset();
            document.getElementById('truck-id').value = '';
            document.getElementById('edit-title').textContent = '新增車輛';
            imagePreviews.innerHTML = '';
            editingImages = [];
            truckImages = [];
            
            // 顯示編輯頁面
            showPage('edit-page');
        });
        
        // 取消編輯按鈕事件
        cancelEditBtn.addEventListener('click', () => {
            // 返回前一頁
            window.history.back();
        });
        
        // 處理圖片上傳預覽
        truckImagesInput.addEventListener('change', async (e) => {
            const files = e.target.files;
            
            if (!files.length) return;
            
            // 顯示處理中訊息
            imagePreviews.innerHTML = '<p>處理圖片中，請稍候...</p>';
            
            // 保留原有的圖片（如果是編輯狀態）
            let currentImages = [...truckImages];
            
            // 處理新選擇的檔案
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // 只接受圖片檔案
                if (!file.type.startsWith('image/')) continue;
                
                try {
                    // 壓縮圖片
                    const compressedFile = await compressImage(file);
                    currentImages.push(compressedFile);
                } catch (error) {
                    console.error('圖片壓縮失敗:', error);
                    currentImages.push(file); // 如果壓縮失敗，使用原圖
                }
            }
            
            truckImages = currentImages;
            truckImageOrder = Array.from({ length: truckImages.length }, (_, i) => i);
            
            // 清空預覽區域
            imagePreviews.innerHTML = '';
            
            // 渲染預覽
            renderImagePreviews();
        });

        // 渲染圖片預覽的函數
        function renderImagePreviews() {
            imagePreviews.innerHTML = '';
            
            // 根據排序顯示圖片
            truckImageOrder.forEach((originalIndex, displayIndex) => {
                const file = truckImages[originalIndex];
                
                // 創建預覽元素
                const preview = document.createElement('div');
                preview.className = 'image-preview';
                preview.dataset.index = originalIndex;
                preview.draggable = true;
                
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                
                // 添加拖拽事件
                preview.addEventListener('dragstart', handleDragStart);
                preview.addEventListener('dragover', handleDragOver);
                preview.addEventListener('dragleave', handleDragLeave);
                preview.addEventListener('drop', handleDrop);
                preview.addEventListener('dragend', handleDragEnd);
                
                // 移除按鈕
                const removeBtn = document.createElement('div');
                removeBtn.className = 'remove-image';
                removeBtn.innerHTML = '×';
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    // 從陣列中移除檔案
                    const index = originalIndex;
                    if (index > -1) {
                        // 移除圖片
                        truckImages.splice(index, 1);
                        
                        // 更新排序陣列
                        truckImageOrder = truckImageOrder
                            .filter(i => i !== index)
                            .map(i => i > index ? i - 1 : i);
                        
                        // 更新主圖索引
                        if (mainImageIndex === index) {
                            mainImageIndex = 0;
                        } else if (mainImageIndex > index) {
                            mainImageIndex--;
                        }
                        
                        // 重新渲染預覽
                        renderImagePreviews();
                    }
                });
                
                // 設置主圖按鈕
                const setMainBtn = document.createElement('div');
                setMainBtn.className = 'set-main-image';
                setMainBtn.innerHTML = '★';
                setMainBtn.title = '設為主圖';
                setMainBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    mainImageIndex = originalIndex;
                    renderImagePreviews();
                });
                
                // 如果是主圖，添加標記
                if (originalIndex === mainImageIndex) {
                    const mainBadge = document.createElement('div');
                    mainBadge.className = 'main-image-badge';
                    mainBadge.textContent = '主圖';
                    preview.appendChild(mainBadge);
                }
                
                // 點擊預覽開啟全屏查看
                preview.addEventListener('click', () => {
                    openFullscreenView(truckImageOrder.map(idx => truckImages[idx]), displayIndex);
                });
                
                preview.appendChild(img);
                preview.appendChild(removeBtn);
                preview.appendChild(setMainBtn);
                imagePreviews.appendChild(preview);
            });
        }

        // 拖拽相關函數
        let draggedItem = null;

        function handleDragStart(e) {
            this.classList.add('dragging');
            draggedItem = this;
            e.dataTransfer.setData('text/plain', this.dataset.index);
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragLeave() {
            this.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            
            if (draggedItem === this) return;
            
            const fromIndex = truckImageOrder.indexOf(parseInt(draggedItem.dataset.index));
            const toIndex = truckImageOrder.indexOf(parseInt(this.dataset.index));
            
            // 重新排序
            const element = truckImageOrder.splice(fromIndex, 1)[0];
            truckImageOrder.splice(toIndex, 0, element);
            
            renderImagePreviews();
        }

        function handleDragEnd() {
            this.classList.remove('dragging');
        }

        // 開啟全屏查看
        function openFullscreenView(images, startIndex = 0) {
            const modal = document.getElementById('fullscreen-image-modal');
            const container = modal.querySelector('.fullscreen-slider-container');
            const nav = modal.querySelector('.fullscreen-slider-nav');
            
            // 清空容器
            container.innerHTML = '';
            nav.innerHTML = '';
            
            // 當前縮放等級
            let currentZoom = 1;
            
            // 添加圖片
            images.forEach((file, index) => {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = 'fullscreen-image';
                img.style.display = index === startIndex ? 'block' : 'none';
                img.dataset.index = index;
                container.appendChild(img);
                
                // 添加導航點
                const dot = document.createElement('div');
                dot.className = `fullscreen-dot ${index === startIndex ? 'active' : ''}`;
                dot.dataset.index = index;
                dot.addEventListener('click', () => {
                    // 重置縮放
                    currentZoom = 1;
                    resetZoom();
                    
                    // 切換圖片
                    container.querySelectorAll('.fullscreen-image').forEach(img => {
                        img.style.display = 'none';
                    });
                    container.querySelector(`.fullscreen-image[data-index="${index}"]`).style.display = 'block';
                    
                    // 更新導航點
                    nav.querySelectorAll('.fullscreen-dot').forEach(d => {
                        d.classList.remove('active');
                    });
                    dot.classList.add('active');
                });
                nav.appendChild(dot);
            });
            
            // 綁定縮放按鈕
            document.getElementById('zoom-in').onclick = () => {
                currentZoom += 0.2;
                updateZoom();
            };
            
            document.getElementById('zoom-out').onclick = () => {
                currentZoom = Math.max(0.5, currentZoom - 0.2);
                updateZoom();
            };
            
            document.getElementById('zoom-reset').onclick = () => {
                currentZoom = 1;
                resetZoom();
            };
            
            function updateZoom() {
                const currentImg = container.querySelector('.fullscreen-image[style*="display: block"]');
                if (currentImg) {
                    currentImg.style.transform = `scale(${currentZoom})`;
                }
            }
            
            function resetZoom() {
                container.querySelectorAll('.fullscreen-image').forEach(img => {
                    img.style.transform = `scale(1)`;
                });
            }
            
            // 顯示模態窗口
            modal.style.display = 'block';
            
            // 關閉按鈕事件
            document.getElementById('close-fullscreen-modal').onclick = () => {
                modal.style.display = 'none';
            };
            
            // 點擊模態窗口背景關閉
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            };
        }
        
        // 加載編輯的車輛資訊
        async function editTruck(truckId) {
            try {
                const doc = await db.collection('trucks').doc(truckId).get();
                
                if (!doc.exists) {
                    alert('找不到此車輛資訊');
                    return;
                }
                
                const truck = { id: doc.id, ...doc.data() };
                
                // 填充表單
                document.getElementById('truck-id').value = truck.id;
                document.getElementById('truck-brand').value = truck.brand;
                document.getElementById('truck-model').value = truck.model;
                document.getElementById('truck-type').value = truck.type;
                document.getElementById('truck-price').value = truck.price;
                document.getElementById('truck-year').value = truck.year;
                document.getElementById('truck-weight').value = truck.weight;
                document.getElementById('truck-length').value = truck.length;
                document.getElementById('truck-engine').value = truck.engine || '';
                document.getElementById('truck-condition').value = truck.condition;
                document.getElementById('truck-status').value = truck.status;
                document.getElementById('truck-description').value = truck.description || '';
                document.getElementById('seller-name').value = truck.sellerName;
                document.getElementById('seller-contact').value = truck.sellerContact;
                
                // 設置頁面標題
                document.getElementById('edit-title').textContent = '編輯車輛';
                
                // 清空圖片預覽
                imagePreviews.innerHTML = '';
                editingImages = truck.images || [];
                
                // 顯示現有圖片預覽
                // 重置圖片排序和主圖索引
                truckImageOrder = Array.from({ length: editingImages.length }, (_, i) => i);
                mainImageIndex = 0; // 默認第一張為主圖

                // 顯示現有圖片預覽
                if (editingImages.length > 0) {
                    // 創建拖曳排序預覽
                    truckImageOrder.forEach((originalIndex, displayIndex) => {
                        const imageUrl = editingImages[originalIndex];
                        
                        const preview = document.createElement('div');
                        preview.className = 'image-preview';
                        preview.dataset.index = originalIndex;
                        preview.draggable = true;
                        
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        
                        // 添加拖曳事件
                        preview.addEventListener('dragstart', (e) => {
                            preview.classList.add('dragging');
                            draggedItem = preview;
                            e.dataTransfer.setData('text/plain', preview.dataset.index);
                            e.dataTransfer.effectAllowed = 'move';
                        });
                        
                        preview.addEventListener('dragover', (e) => {
                            e.preventDefault();
                            e.dataTransfer.dropEffect = 'move';
                        });
                        
                        preview.addEventListener('dragleave', () => {
                            preview.classList.remove('dragover');
                        });
                        
                        preview.addEventListener('drop', (e) => {
                            e.preventDefault();
                            
                            if (draggedItem === preview) return;
                            
                            const fromIndex = truckImageOrder.indexOf(parseInt(draggedItem.dataset.index));
                            const toIndex = truckImageOrder.indexOf(parseInt(preview.dataset.index));
                            
                            // 重新排序
                            const element = truckImageOrder.splice(fromIndex, 1)[0];
                            truckImageOrder.splice(toIndex, 0, element);
                            
                            // 重新渲染
                            renderEditingImagePreviews();
                        });
                        
                        preview.addEventListener('dragend', () => {
                            preview.classList.remove('dragging');
                        });
                        
                        // 移除按鈕
                        const removeBtn = document.createElement('div');
                        removeBtn.className = 'remove-image';
                        removeBtn.innerHTML = '×';
                        removeBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            
                            // 從陣列中移除
                            const index = originalIndex;
                            editingImages.splice(index, 1);
                            
                            // 更新排序陣列
                            truckImageOrder = truckImageOrder
                                .filter(i => i !== index)
                                .map(i => i > index ? i - 1 : i);
                            
                            // 更新主圖索引
                            if (mainImageIndex === index) {
                                mainImageIndex = 0;
                            } else if (mainImageIndex > index) {
                                mainImageIndex--;
                            }
                            
                            // 重新渲染
                            renderEditingImagePreviews();
                        });
                        
                        // 設置主圖按鈕
                        const setMainBtn = document.createElement('div');
                        setMainBtn.className = 'set-main-image';
                        setMainBtn.innerHTML = '★';
                        setMainBtn.title = '設為主圖';
                        setMainBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            mainImageIndex = originalIndex;
                            renderEditingImagePreviews();
                        });
                        
                        // 如果是主圖，添加標記
                        if (originalIndex === mainImageIndex) {
                            const mainBadge = document.createElement('div');
                            mainBadge.className = 'main-image-badge';
                            mainBadge.textContent = '主圖';
                            preview.appendChild(mainBadge);
                        }
                        
                        // 點擊預覽開啟全屏查看
                        preview.addEventListener('click', () => {
                            openEditingFullscreenView(displayIndex);
                        });
                        
                        preview.appendChild(img);
                        preview.appendChild(removeBtn);
                        preview.appendChild(setMainBtn);
                        imagePreviews.appendChild(preview);
                    });
                }
                
                // 顯示編輯頁
                showPage('edit-page');
                
            } catch (error) {
                console.error('載入車輛編輯資訊失敗:', error);
                alert('載入車輛編輯資訊失敗，請稍後再試');
            }
        }

        // 渲染編輯中的圖片預覽
        function renderEditingImagePreviews() {
            imagePreviews.innerHTML = '';
            
            truckImageOrder.forEach((originalIndex, displayIndex) => {
                const imageUrl = editingImages[originalIndex];
                
                const preview = document.createElement('div');
                preview.className = 'image-preview';
                preview.dataset.index = originalIndex;
                preview.draggable = true;
                
                const img = document.createElement('img');
                img.src = imageUrl;
                
                // 添加拖曳事件
                preview.addEventListener('dragstart', (e) => {
                    preview.classList.add('dragging');
                    draggedItem = preview;
                    e.dataTransfer.setData('text/plain', preview.dataset.index);
                    e.dataTransfer.effectAllowed = 'move';
                });
                
                preview.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });
                
                preview.addEventListener('dragleave', () => {
                    preview.classList.remove('dragover');
                });
                
                preview.addEventListener('drop', (e) => {
                    e.preventDefault();
                    
                    if (draggedItem === preview) return;
                    
                    const fromIndex = truckImageOrder.indexOf(parseInt(draggedItem.dataset.index));
                    const toIndex = truckImageOrder.indexOf(parseInt(preview.dataset.index));
                    
                    // 重新排序
                    const element = truckImageOrder.splice(fromIndex, 1)[0];
                    truckImageOrder.splice(toIndex, 0, element);
                    
                    // 重新渲染
                    renderEditingImagePreviews();
                });
                
                preview.addEventListener('dragend', () => {
                    preview.classList.remove('dragging');
                });
                
                // 移除按鈕
                const removeBtn = document.createElement('div');
                removeBtn.className = 'remove-image';
                removeBtn.innerHTML = '×';
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    // 從陣列中移除
                    const index = originalIndex;
                    editingImages.splice(index, 1);
                    
                    // 更新排序陣列
                    truckImageOrder = truckImageOrder
                        .filter(i => i !== index)
                        .map(i => i > index ? i - 1 : i);
                    
                    // 更新主圖索引
                    if (mainImageIndex === index) {
                        mainImageIndex = 0;
                    } else if (mainImageIndex > index) {
                        mainImageIndex--;
                    }
                    
                    // 重新渲染
                    renderEditingImagePreviews();
                });
                
                // 設置主圖按鈕
                const setMainBtn = document.createElement('div');
                setMainBtn.className = 'set-main-image';
                setMainBtn.innerHTML = '★';
                setMainBtn.title = '設為主圖';
                setMainBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    mainImageIndex = originalIndex;
                    renderEditingImagePreviews();
                });
                
                // 如果是主圖，添加標記
                if (originalIndex === mainImageIndex) {
                    const mainBadge = document.createElement('div');
                    mainBadge.className = 'main-image-badge';
                    mainBadge.textContent = '主圖';
                    preview.appendChild(mainBadge);
                }
                
                // 點擊預覽開啟全屏查看
                preview.addEventListener('click', () => {
                    openEditingFullscreenView(displayIndex);
                });
                
                preview.appendChild(img);
                preview.appendChild(removeBtn);
                preview.appendChild(setMainBtn);
                imagePreviews.appendChild(preview);
            });
        }

        // 開啟編輯中圖片的全屏查看
        function openEditingFullscreenView(startIndex = 0) {
            const modal = document.getElementById('fullscreen-image-modal');
            const container = modal.querySelector('.fullscreen-slider-container');
            const nav = modal.querySelector('.fullscreen-slider-nav');
            
            // 清空容器
            container.innerHTML = '';
            nav.innerHTML = '';
            
            // 當前縮放等級
            let currentZoom = 1;
            
            // 按排序獲取圖片URL列表
            const orderedImages = truckImageOrder.map(index => editingImages[index]);
            
            // 添加圖片
            orderedImages.forEach((imageUrl, index) => {
                const img = document.createElement('img');
                img.src = imageUrl;
                img.className = 'fullscreen-image';
                img.style.display = index === startIndex ? 'block' : 'none';
                img.dataset.index = index;
                container.appendChild(img);
                
                // 添加導航點
                const dot = document.createElement('div');
                dot.className = `fullscreen-dot ${index === startIndex ? 'active' : ''}`;
                dot.dataset.index = index;
                dot.addEventListener('click', () => {
                    // 重置縮放
                    currentZoom = 1;
                    resetZoom();
                    
                    // 切換圖片
                    container.querySelectorAll('.fullscreen-image').forEach(img => {
                        img.style.display = 'none';
                    });
                    container.querySelector(`.fullscreen-image[data-index="${index}"]`).style.display = 'block';
                    
                    // 更新導航點
                    nav.querySelectorAll('.fullscreen-dot').forEach(d => {
                        d.classList.remove('active');
                    });
                    dot.classList.add('active');
                });
                nav.appendChild(dot);
            });
            
            // 綁定縮放按鈕
            document.getElementById('zoom-in').onclick = () => {
                currentZoom += 0.2;
                updateZoom();
            };
            
            document.getElementById('zoom-out').onclick = () => {
                currentZoom = Math.max(0.5, currentZoom - 0.2);
                updateZoom();
            };
            
            document.getElementById('zoom-reset').onclick = () => {
                currentZoom = 1;
                resetZoom();
            };
            
            function updateZoom() {
                const currentImg = container.querySelector('.fullscreen-image[style*="display: block"]');
                if (currentImg) {
                    currentImg.style.transform = `scale(${currentZoom})`;
                }
            }
            
            function resetZoom() {
                container.querySelectorAll('.fullscreen-image').forEach(img => {
                    img.style.transform = `scale(1)`;
                });
            }
            
            // 顯示模態窗口
            modal.style.display = 'block';
            
            // 關閉按鈕事件
            document.getElementById('close-fullscreen-modal').onclick = () => {
                modal.style.display = 'none';
            };
            
            // 點擊模態窗口背景關閉
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            };
        }
        
        // 表單提交處理
        truckForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // 顯示加載中提示
            const submitBtn = truckForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '儲存中...';
            submitBtn.disabled = true;
            
            try {
                // 獲取表單數據
                const truckId = document.getElementById('truck-id').value;
                const formData = {
                    brand: document.getElementById('truck-brand').value,
                    model: document.getElementById('truck-model').value,
                    type: document.getElementById('truck-type').value,
                    tailgateLift: document.getElementById('tailgate-lift').value,
                    price: parseFloat(document.getElementById('truck-price').value),
                    year: parseInt(document.getElementById('truck-year').value),
                    emissionPhase: document.getElementById('emission-phase').value,
                    weight: parseFloat(document.getElementById('truck-weight').value),
                    length: parseFloat(document.getElementById('truck-length').value),
                    engine: document.getElementById('truck-engine').value,
                    condition: document.getElementById('truck-condition').value,
                    status: document.getElementById('truck-status').value,
                    description: document.getElementById('truck-description').value,
                    sellerName: document.getElementById('seller-name').value,
                    sellerContact: document.getElementById('seller-contact').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // 上傳新圖片（如果有）
                let imageUrls = [];

                // 處理現有的編輯圖片（按照排序和主圖設置）
                if (editingImages.length > 0) {
                    // 排序後的編輯圖片URLs
                    const orderedEditingImages = [];
                    
                    // 首先添加主圖（如果主圖在editingImages中）
                    if (mainImageIndex < editingImages.length) {
                        orderedEditingImages.push(editingImages[mainImageIndex]);
                    }
                    
                    // 添加其他圖片（按排序）
                    truckImageOrder.forEach(index => {
                        if (index !== mainImageIndex && index < editingImages.length) {
                            orderedEditingImages.push(editingImages[index]);
                        }
                    });
                    
                    imageUrls = orderedEditingImages;
                }

                // 處理新上傳的圖片
                if (truckImages.length > 0) {
                    // 排序後的新圖片
                    const orderedNewImages = [];
                    
                    // 處理主圖索引對應的新圖片
                    let mainImageProcessed = false;
                    if (mainImageIndex >= editingImages.length) {
                        // 主圖是新上傳的圖片
                        const adjustedIndex = mainImageIndex - editingImages.length;
                        if (adjustedIndex >= 0 && adjustedIndex < truckImages.length) {
                            orderedNewImages.push(truckImages[adjustedIndex]);
                            mainImageProcessed = true;
                        }
                    }
                    
                    // 添加其他新圖片（按排序）
                    for (let i = 0; i < truckImages.length; i++) {
                        if (mainImageProcessed && i === mainImageIndex - editingImages.length) {
                            // 跳過已處理的主圖
                            continue;
                        }
                        orderedNewImages.push(truckImages[i]);
                    }
                    
                    // 上傳新圖片
                    for (const file of orderedNewImages) {
                        // 創建唯一的檔案名
                        const fileName = `trucks/${Date.now()}-${Math.random().toString(36).substring(2)}.${file.name.split('.').pop()}`;
                        
                        // 上傳到 Firebase Storage
                        const fileRef = storage.ref().child(fileName);
                        await fileRef.put(file);
                        
                        // 獲取下載 URL
                        const downloadUrl = await fileRef.getDownloadURL();
                        imageUrls.push(downloadUrl);
                    }
                }

                // 添加圖片URL到表單數據
                formData.images = imageUrls;
                
                // 保存到 Firestore
                if (truckId) {
                    // 更新現有車輛
                    await db.collection('trucks').doc(truckId).update(formData);
                } else {
                    // 添加新車輛
                    formData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    formData.views = 0;
                    await db.collection('trucks').add(formData);
                }
                
                // 成功處理
                alert(truckId ? '車輛資訊已更新' : '車輛已成功添加');
                
                // 重新載入
                loadTrucks(true);
                
                // 返回首頁
                showPage('home-page');
                
            } catch (error) {
                console.error('儲存車輛資訊失敗:', error);
                alert('儲存車輛資訊失敗，請稍後再試');
            } finally {
                // 恢復按鈕狀態
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }

            // 添加賣家郵箱到表單數據
            formData.sellerEmail = currentUser.email;

        });
        
        // ============ 用戶認證功能 (預留) ============
        
        // 監聽認證狀態變化
        auth.onAuthStateChanged(user => {
            currentUser = user;
            updateUIForAuth();
        });
        
        // 更新UI顯示登入狀態
        function updateUIForAuth() {
            if (currentUser) {
                // 用戶已登入
                document.querySelectorAll('.auth-only').forEach(el => {
                    el.style.display = 'block';
                });
                document.querySelectorAll('.non-auth').forEach(el => {
                    el.style.display = 'none';
                });
                
                // 更新導覽列
                document.getElementById('profile-nav-btn').querySelector('div').textContent = '個人';
            } else {
                // 用戶未登入
                document.querySelectorAll('.auth-only').forEach(el => {
                    el.style.display = 'none';
                });
                document.querySelectorAll('.non-auth').forEach(el => {
                    el.style.display = 'block';
                });
                
                // 更新導覽列
                document.getElementById('profile-nav-btn').querySelector('div').textContent = '業務';
            }
        }
        
        // 登入表單提交處理
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                showPage('home-page');
            } catch (error) {
                console.error('登入失敗:', error);
                alert('登入失敗: ' + error.message);
            }
        });
        
        // 註冊連結點擊事件
        document.getElementById('register-link').addEventListener('click', (e) => {
            e.preventDefault();
            showPage('register-page');
        });

        // 返回登入按鈕事件
        document.getElementById('back-to-login').addEventListener('click', () => {
            showPage('login-page');
        });

        // 忘記密碼相關功能
        const forgotPasswordModal = document.getElementById('forgot-password-modal');
        const forgotPasswordBtn = document.getElementById('forgot-password-btn');
        const closeForgotModal = document.getElementById('close-forgot-modal');
        const sendResetBtn = document.getElementById('send-reset-btn');
        const cancelResetBtn = document.getElementById('cancel-reset-btn');
        const resetMessage = document.getElementById('reset-message');

        // 打開忘記密碼模態視窗
        forgotPasswordBtn.addEventListener('click', () => {
            forgotPasswordModal.style.display = 'block';
            document.getElementById('reset-email').value = '';
            resetMessage.innerHTML = '';
        });

        // 關閉模態視窗的不同方式
        closeForgotModal.addEventListener('click', () => {
            forgotPasswordModal.style.display = 'none';
        });

        cancelResetBtn.addEventListener('click', () => {
            forgotPasswordModal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === forgotPasswordModal) {
                forgotPasswordModal.style.display = 'none';
            }
        });

        // 發送重設密碼郵件
        sendResetBtn.addEventListener('click', async () => {
            const email = document.getElementById('reset-email').value;
            
            if (!email) {
                resetMessage.innerHTML = '<p style="color: red;">請輸入電子郵件地址</p>';
                return;
            }
            
            try {
                // 顯示處理中訊息
                resetMessage.innerHTML = '<p>處理中，請稍候...</p>';
                sendResetBtn.disabled = true;
                
                // 檢查電子郵件是否存在
                const methods = await firebase.auth().fetchSignInMethodsForEmail(email);
                
                if (methods.length === 0) {
                    resetMessage.innerHTML = '<p style="color: red;">此電子郵件尚未註冊</p>';
                    sendResetBtn.disabled = false;
                    return;
                }
                
                // 使用 Firebase Auth 發送重設密碼郵件
                await auth.sendPasswordResetEmail(email, {
                    url: window.location.origin, // 重設密碼後返回當前網站
                    handleCodeInApp: false // 在瀏覽器中處理
                });
                
                // 成功發送
                resetMessage.innerHTML = '<p style="color: green;">重設密碼連結已發送到您的電子郵件。請檢查您的收件匣或垃圾郵件資料夾。</p>';
                setTimeout(() => {
                    forgotPasswordModal.style.display = 'none';
                }, 5000); // 5秒後自動關閉
                
            } catch (error) {
                console.error('發送重設密碼郵件失敗:', error);
                
                // 根據錯誤碼顯示相應訊息
                if (error.code === 'auth/user-not-found') {
                    resetMessage.innerHTML = '<p style="color: red;">此電子郵件尚未註冊</p>';
                } else if (error.code === 'auth/invalid-email') {
                    resetMessage.innerHTML = '<p style="color: red;">無效的電子郵件格式</p>';
                } else if (error.code === 'auth/too-many-requests') {
                    resetMessage.innerHTML = '<p style="color: red;">請求次數過多，請稍後再試</p>';
                } else {
                    resetMessage.innerHTML = `<p style="color: red;">發送失敗: ${error.message}</p>`;
                }
            } finally {
                sendResetBtn.disabled = false;
            }
        });

        // ============ 註冊功能 ============

        // 所屬科別選項
        const departmentOptions = {
            headquarter: ['總公司'],
            north: ['台北一科', '台北二科', '台北三科', '台北四科'],
            central: ['中壢一科', '中壢二科', '中壢三科', '中壢四科', '新竹科', '台中一科', '台中二科', '台中三科', '嘉雲科'],
            south: ['台南科', '高雄一科', '高雄二科', '高雄三科']
        };

        // 根據選擇的地區更新科別選項
        document.getElementById('register-region').addEventListener('change', function() {
            const region = this.value;
            const departmentSelect = document.getElementById('register-department');
            
            // 清空現有選項
            departmentSelect.innerHTML = '';
            
            if (!region) {
                departmentSelect.innerHTML = '<option value="">請先選擇地區</option>';
                departmentSelect.disabled = true;
                return;
            }
            
            // 添加新選項
            departmentSelect.disabled = false;
            departmentSelect.innerHTML = '<option value="">選擇科別</option>';
            
            departmentOptions[region].forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                departmentSelect.appendChild(option);
            });
        });

        // 員工編號驗證
        document.getElementById('register-employee-id').addEventListener('input', function() {
            const value = this.value.replace(/\D/g, ''); // 只保留數字
            this.value = value;
            
            // 驗證4-5位數字
            if (value.length > 5) {
                this.value = value.slice(0, 5);
            }
        });

        // 電話號碼驗證（分機和手機）
        ['register-extension', 'register-phone'].forEach(id => {
            document.getElementById(id).addEventListener('input', function() {
                const value = this.value.replace(/\D/g, ''); // 只保留數字
                this.value = value;
            });
        });

        // 註冊表單提交
        document.getElementById('register-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('register-email').value;
            const name = document.getElementById('register-name').value; // 新增這行
            const region = document.getElementById('register-region').value;
            const department = document.getElementById('register-department').value;
            const employeeId = document.getElementById('register-employee-id').value;
            const extension = document.getElementById('register-extension').value;
            const phone = document.getElementById('register-phone').value;
            const companyEmail = document.getElementById('register-company-email').value;
            const fullCompanyEmail = companyEmail ? `${companyEmail}@chailease.com.tw` : '';
            const lineId = document.getElementById('register-line-id').value;
            const introduction = document.getElementById('register-introduction').value;
            
            // 表單驗證
            if (!email || !region || !department || !employeeId || !extension || !phone) {
                document.getElementById('register-message').innerHTML = '<p style="color: red;">請填寫所有必填欄位</p>';
                return;
            }
            
            if (!/^\d{4,5}$/.test(employeeId)) {
                document.getElementById('register-message').innerHTML = '<p style="color: red;">員工編號必須是4-5位數字</p>';
                return;
            }
            
            // 禁用提交按鈕防止重複提交
            const submitBtn = document.querySelector('#register-form button[type="submit"]');
            const originalBtnText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = '處理中...';
            
            try {
                // 檢查電子郵件是否已存在
                const emailExists = await checkEmailExists(email);
                if (emailExists) {
                    document.getElementById('register-message').innerHTML = '<p style="color: red;">此電子郵件已被註冊</p>';
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                    return;
                }
                
                // 生成隨機密碼
                const randomPassword = generateRandomPassword();
                
                // 創建用戶帳號
                const userCredential = await auth.createUserWithEmailAndPassword(email, randomPassword);
                const userId = userCredential.user.uid;
                
                // 發送首次開通密碼郵件
                await auth.sendPasswordResetEmail(email);
                
                // 儲存用戶資料到 Firestore
                await db.collection('users').doc(userId).set({
                    email: email,
                    name: name,
                    region: region,
                    department: department,
                    employeeId: employeeId,
                    extension: extension,
                    phone: phone,
                    companyEmail: fullCompanyEmail,
                    lineId: lineId, // 新增
                    introduction: introduction, // 新增
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    truckCount: 0
                });
                
                // 顯示註冊成功訊息
                document.getElementById('register-form').reset();
                document.getElementById('register-success-modal').style.display = 'block';
                
            } catch (error) {
                console.error('註冊失敗:', error);
                let errorMessage = '註冊失敗，請稍後再試';
                
                // 根據錯誤類型顯示特定訊息
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = '此電子郵件已被註冊';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = '無效的電子郵件格式';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = '密碼強度不足';
                }
                
                document.getElementById('register-message').innerHTML = `<p style="color: red;">${errorMessage}</p>`;
            } finally {
                // 恢復提交按鈕
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
            }
        });

        // 檢查電子郵件是否已存在
        async function checkEmailExists(email) {
            try {
                const methods = await firebase.auth().fetchSignInMethodsForEmail(email);
                return methods.length > 0;
            } catch (error) {
                console.error('檢查電子郵件失敗:', error);
                return false;
            }
        }

        // 生成隨機密碼
        function generateRandomPassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()';
            let password = '';
            for (let i = 0; i < 12; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        // 註冊成功模態視窗相關事件
        document.getElementById('close-register-success-modal').addEventListener('click', () => {
            document.getElementById('register-success-modal').style.display = 'none';
            showPage('login-page');
        });

        document.getElementById('go-to-login-btn').addEventListener('click', () => {
            document.getElementById('register-success-modal').style.display = 'none';
            showPage('login-page');
        });
        
        // ============ 離線功能 ============
        
        // 檢查是否支援 Service Worker
        if ('serviceWorker' in navigator && 'caches' in window) {
            // 註冊 Service Worker (需要另外實現 sw.js)
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('Service Worker 註冊成功:', registration);
                })
                .catch(error => {
                    console.error('Service Worker 註冊失敗:', error);
                });
                
            // 離線模式檢測
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            
            function updateOnlineStatus() {
                const isOnline = navigator.onLine;
                if (!isOnline) {
                    // 顯示離線提示
                    alert('您現在處於離線模式，部分功能可能受限');
                }
            }
        }
        
        // ============ 初始化應用 ============
        
        // 頁面載入完成後執行
        document.addEventListener('DOMContentLoaded', () => {
            // 載入車輛列表
            loadTrucks(true);
            
            // 初始化 UI
            updateUIForAuth();

            // 生成年份選項
            const yearSelect = document.getElementById('truck-year');
            if (yearSelect) {
                const currentYear = new Date().getFullYear();
                for (let year = currentYear; year >= 1985; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                }
            }
            
        });

        // 業務按鈕點擊處理
        document.getElementById('profile-nav-btn').addEventListener('click', function(e) {
            e.preventDefault();
            if (currentUser) {
                // 已登入則顯示個人資料頁面
                showUserProfile();
                showPage('profile-page');
            } else {
                // 未登入則顯示登入頁面
                showPage('login-page');
            }
        });

        // 顯示用戶個人資料
        function showUserProfile() {
            // 檢查用戶是否登入
            if (!currentUser) return;
            
            // 從 Firestore 獲取用戶資料
            db.collection('users').doc(currentUser.uid).get()
                .then(doc => {
                    const userData = doc.exists ? doc.data() : {
                        name: '未設定',
                        employeeId: '未設定',
                        department: '未設定',
                        extension: '未設定',
                        phone: '未設定',
                        truckCount: 0
                    };
                    
                    // 填充個人資料頁
                    document.getElementById('user-profile').innerHTML = `
                        <div class="text-center mb-2">
                            <img src="${userData.avatarUrl || '/api/placeholder/100/100'}" alt="頭像" 
                                style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover;">
                        </div>
                        <h3 class="mb-1 text-center">${userData.name || '未設定姓名'}</h3>
                        <table style="width: 100%; margin-bottom: 15px;">
                            <tr>
                                <td style="width: 40%; font-weight: bold;">電子郵件</td>
                                <td>${currentUser.email}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold;">員工編號</td>
                                <td>${userData.employeeId}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold;">所屬分公司</td>
                                <td>${userData.region || '未設定'}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold;">所屬科別</td>
                                <td>${userData.department || '未設定'}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold;">分機號碼</td>
                                <td>${userData.extension}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold;">手機號碼</td>
                                <td>${userData.phone}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold;">LINE ID</td>
                                <td>${userData.lineId || '未設定'}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; vertical-align: top;">個人簡介</td>
                                <td style="white-space: pre-line;">${userData.introduction || '未設定'}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold;">上傳車輛數</td>
                                <td>${userData.truckCount || 0} 輛</td>
                            </tr>
                        </table>
                    `;

                    // 在顯示完用戶資料表格後添加複製聯絡資訊按鈕
                    document.getElementById('user-profile').innerHTML += `
                        <div class="mt-2">
                            <button type="button" class="btn" id="copy-contact-info">複製聯絡資訊</button>
                        </div>
                    `;

                    // 綁定複製按鈕點擊事件
                    document.getElementById('copy-contact-info').addEventListener('click', function() {
                        const contactInfo = `姓名: ${userData.name || '未設定'}
                    電話: ${userData.phone || '未設定'}
                    分機: ${userData.extension || '未設定'}
                    LINE ID: ${userData.lineId || '未設定'}
                    電子郵件: ${currentUser.email}`;
                        
                        // 創建臨時文本區域進行複製
                        const textarea = document.createElement('textarea');
                        textarea.value = contactInfo;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        
                        // 顯示複製成功提示
                        alert('聯絡資訊已複製到剪貼板');
                    });
                    
                    // 顯示銷售統計
                    showUserSalesStats();
                })
                .catch(error => {
                    console.error('獲取用戶資料失敗:', error);
                    document.getElementById('user-profile').innerHTML = `
                        <p class="text-center">獲取用戶資料失敗，請稍後再試</p>
                    `;
                });

            // 在最後添加
            showUserTrucks(); // 顯示用戶的車輛列表

            // 在最後添加
            showLatestTrucks(); // 顯示同事最新上架的車輛

        }

        // 顯示用戶的車輛列表
        function showUserTrucks() {
            // 檢查用戶是否登入
            if (!currentUser) return;
            
            const trucksContainer = document.getElementById('my-trucks-list');
            trucksContainer.innerHTML = '<p class="text-center">載入中...</p>';
            
            // 獲取該業務的車輛資料
            db.collection('trucks')
                .where('sellerEmail', '==', currentUser.email)
                .orderBy('createdAt', 'desc')
                .limit(5) // 只顯示最近5台
                .get()
                .then(querySnapshot => {
                    if (querySnapshot.empty) {
                        trucksContainer.innerHTML = '<p class="text-center">您還沒有上架任何車輛</p>';
                        return;
                    }
                    
                    // 渲染車輛列表
                    trucksContainer.innerHTML = '';
                    
                    querySnapshot.forEach(doc => {
                        const truck = { id: doc.id, ...doc.data() };
                        
                        // 根據狀態設定不同的樣式和按鈕
                        let statusClass = '';
                        let nextStatusText = '';
                        let nextStatus = '';
                        
                        switch(truck.status) {
                            case 'available':
                                statusClass = 'status-available';
                                nextStatusText = '標記為洽談中';
                                nextStatus = 'pending';
                                break;
                            case 'pending':
                                statusClass = 'status-pending';
                                nextStatusText = '標記為已售出';
                                nextStatus = 'sold';
                                break;
                            case 'sold':
                                statusClass = 'status-sold';
                                nextStatusText = '恢復為可售';
                                nextStatus = 'available';
                                break;
                        }
                        
                        // 創建車輛卡片
                        const truckItem = document.createElement('div');
                        truckItem.className = 'card mb-2';
                        truckItem.innerHTML = `
                            <div class="card-content">
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <img src="${truck.images && truck.images.length > 0 ? truck.images[0] : '/api/placeholder/60/60'}" 
                                        alt="${truck.brand} ${truck.model}" 
                                        style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 10px;">
                                    <div>
                                        <div style="font-weight: bold;">${truck.brand} ${truck.model}</div>
                                        <div>${truck.year}年 / ${truck.price}萬元</div>
                                        <div class="card-status ${statusClass}" style="display: inline-block; font-size: 12px; margin-top: 4px;">
                                            ${truck.status === 'available' ? '可售' : truck.status === 'pending' ? '洽談中' : '已售出'}
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-block change-status-btn" data-id="${truck.id}" data-status="${nextStatus}">
                                        ${nextStatusText}
                                    </button>
                                    <button class="btn btn-block edit-truck-btn" data-id="${truck.id}">
                                        編輯資訊
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        trucksContainer.appendChild(truckItem);
                    });
                    
                    // 添加查看全部按鈕
                    const viewAllBtn = document.createElement('div');
                    viewAllBtn.className = 'mt-2';
                    viewAllBtn.innerHTML = `
                        <button class="btn btn-block" id="view-all-my-trucks-btn">查看全部車輛</button>
                    `;
                    trucksContainer.appendChild(viewAllBtn);
                    
                    // 綁定狀態變更按鈕事件
                    document.querySelectorAll('.change-status-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const truckId = this.dataset.id;
                            const newStatus = this.dataset.status;
                            
                            // 更新車輛狀態
                            db.collection('trucks').doc(truckId).update({
                                status: newStatus,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            })
                            .then(() => {
                                alert('車輛狀態已更新');
                                showUserTrucks(); // 重新載入
                            })
                            .catch(error => {
                                console.error('更新車輛狀態失敗:', error);
                                alert('更新失敗: ' + error.message);
                            });
                        });
                    });
                    
                    // 綁定編輯按鈕事件
                    document.querySelectorAll('.edit-truck-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const truckId = this.dataset.id;
                            editTruck(truckId); // 使用現有的編輯車輛函數
                            showPage('edit-page'); // 顯示編輯頁面
                        });
                    });
                    
                    // 綁定查看全部按鈕事件
                    document.getElementById('view-all-my-trucks-btn').addEventListener('click', function() {
                        // 設置篩選條件為當前用戶的車輛
                        activeFilters = {
                            sellerEmail: currentUser.email,
                            status: 'all'
                        };
                        
                        // 載入篩選後的車輛列表
                        loadTrucks(true);
                        
                        // 顯示首頁
                        showPage('home-page');
                    });
                })
                .catch(error => {
                    console.error('獲取用戶車輛失敗:', error);
                    trucksContainer.innerHTML = '<p class="text-center">獲取車輛資訊失敗，請稍後再試</p>';
                });
        }

        // 顯示同事最新上架的車輛
        function showLatestTrucks() {
            // 檢查是否有用戶登入
            if (!currentUser) return;
            
            const latestTrucksContainer = document.getElementById('latest-trucks');
            latestTrucksContainer.innerHTML = '<p class="text-center">載入中...</p>';
            
            // 獲取除了當前用戶外的最新車輛
            db.collection('trucks')
                .where('status', '==', 'available') // 只顯示可售車輛
                .where('sellerEmail', '!=', currentUser.email) // 排除自己的車輛
                .orderBy('sellerEmail') // 必須先按郵箱排序，因為上面使用了不等於條件
                .orderBy('createdAt', 'desc') // 然後按建立時間降序
                .limit(5) // 只顯示最新5台
                .get()
                .then(querySnapshot => {
                    if (querySnapshot.empty) {
                        latestTrucksContainer.innerHTML = '<p class="text-center">目前沒有同事上架的可售車輛</p>';
                        return;
                    }
                    
                    // 渲染車輛列表
                    latestTrucksContainer.innerHTML = '';
                    
                    querySnapshot.forEach(doc => {
                        const truck = { id: doc.id, ...doc.data() };
                        
                        // 創建車輛卡片
                        const truckItem = document.createElement('div');
                        truckItem.className = 'card mb-2';
                        truckItem.innerHTML = `
                            <div class="card-content">
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <img src="${truck.images && truck.images.length > 0 ? truck.images[0] : '/api/placeholder/60/60'}" 
                                        alt="${truck.brand} ${truck.model}" 
                                        style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 10px;">
                                    <div>
                                        <div style="font-weight: bold;">${truck.brand} ${truck.model}</div>
                                        <div>${truck.year}年 / ${truck.price}萬元</div>
                                        <div>業務: ${truck.sellerName}</div>
                                    </div>
                                </div>
                                <button class="btn btn-success btn-block view-detail-btn" data-id="${truck.id}">查看詳情</button>
                            </div>
                        `;
                        
                        latestTrucksContainer.appendChild(truckItem);
                    });
                    
                    // 綁定查看詳情按鈕事件
                    document.querySelectorAll('.view-detail-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const truckId = this.dataset.id;
                            viewTruckDetail(truckId); // 使用現有的查看車輛詳情函數
                        });
                    });
                    
                    // 添加查看全部按鈕
                    const viewAllBtn = document.createElement('div');
                    viewAllBtn.className = 'mt-2';
                    viewAllBtn.innerHTML = `
                        <button class="btn btn-block" id="view-all-latest-trucks-btn">查看全部可售車輛</button>
                    `;
                    latestTrucksContainer.appendChild(viewAllBtn);
                    
                    // 綁定查看全部按鈕事件
                    document.getElementById('view-all-latest-trucks-btn').addEventListener('click', function() {
                        // 重置篩選條件，只篩選可售車輛
                        activeFilters = {
                            status: 'available'
                        };
                        
                        // 載入篩選後的車輛列表
                        loadTrucks(true);
                        
                        // 顯示首頁
                        showPage('home-page');
                    });
                })
                .catch(error => {
                    console.error('獲取最新車輛失敗:', error);
                    latestTrucksContainer.innerHTML = '<p class="text-center">獲取最新車輛失敗，請稍後再試</p>';
                });
        }


        // 登出功能
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await auth.signOut();
                alert('已成功登出');
                showPage('home-page');
            } catch (error) {
                console.error('登出失敗:', error);
                alert('登出失敗: ' + error.message);
            }
        });

        // 頭像上傳預覽
        document.getElementById('profile-avatar').addEventListener('change', function(e) {
            const file = e.target.files[0];
            
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    document.getElementById('profile-avatar-preview').src = e.target.result;
                };
                
                reader.readAsDataURL(file);
            }
        });

        // 修改編輯個人資料按鈕點擊事件
        document.getElementById('edit-profile-btn').addEventListener('click', function() {
            // 獲取當前用戶資料
            db.collection('users').doc(currentUser.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        // 填充編輯表單
                        document.getElementById('edit-name').value = userData.name || '';
                        document.getElementById('edit-phone').value = userData.phone || '';
                        document.getElementById('edit-extension').value = userData.extension || '';
                        document.getElementById('edit-line-id').value = userData.lineId || '';
                        document.getElementById('edit-introduction').value = userData.introduction || '';
                        
                        // 顯示頭像
                        if (userData.avatarUrl) {
                            document.getElementById('profile-avatar-preview').src = userData.avatarUrl;
                        } else {
                            document.getElementById('profile-avatar-preview').src = '/api/placeholder/100/100';
                        }
                        
                        // 處理公司信箱
                        const companyEmail = userData.companyEmail || '';
                        const emailPrefix = companyEmail.split('@')[0] || '';
                        document.getElementById('edit-company-email').value = emailPrefix;
                    }
                    
                    // 顯示編輯頁面
                    showPage('edit-profile-page');
                })
                .catch(error => {
                    console.error('獲取用戶資料失敗:', error);
                    alert('獲取用戶資料失敗，請稍後再試');
                });
        });

        // 取消編輯按鈕點擊事件
        document.getElementById('cancel-edit-profile').addEventListener('click', function() {
            showPage('profile-page');
        });

        // 修改提交編輯表單
        document.getElementById('edit-profile-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // 獲取表單數據
            const name = document.getElementById('edit-name').value;
            const phone = document.getElementById('edit-phone').value;
            const lineId = document.getElementById('edit-line-id').value;
            const introduction = document.getElementById('edit-introduction').value;
            const extension = document.getElementById('edit-extension').value;
            const companyEmailPrefix = document.getElementById('edit-company-email').value;
            const companyEmail = companyEmailPrefix ? `${companyEmailPrefix}@chailease.com.tw` : '';
            const avatarFile = document.getElementById('profile-avatar').files[0];
            
            // 禁用提交按鈕
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = '儲存中...';
            
            try {
                let avatarUrl = null;
                
                // 如果有上傳新頭像，則先上傳到 Storage
                if (avatarFile) {
                    // 創建唯一的檔案名
                    const fileName = `avatars/${currentUser.uid}/${Date.now()}-${Math.random().toString(36).substring(2)}.${avatarFile.name.split('.').pop()}`;
                    
                    // 上傳到 Firebase Storage
                    const fileRef = storage.ref().child(fileName);
                    await fileRef.put(avatarFile);
                    
                    // 獲取下載 URL
                    avatarUrl = await fileRef.getDownloadURL();
                }
                
                // 準備更新的資料
                const updateData = {
                    name: name,
                    phone: phone,
                    extension: extension,
                    companyEmail: companyEmail,
                    lineId: lineId, // 新增
                    introduction: introduction, // 新增
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // 如果有上傳新頭像，則添加到更新資料中
                if (avatarUrl) {
                    updateData.avatarUrl = avatarUrl;
                }
                
                // 更新用戶資料
                await db.collection('users').doc(currentUser.uid).update(updateData);
                
                alert('個人資料已更新');
                
                // 刷新用戶資料並返回個人資料頁
                showUserProfile();
                showPage('profile-page');
                
            } catch (error) {
                console.error('更新用戶資料失敗:', error);
                alert('更新失敗: ' + error.message);
            } finally {
                // 恢復提交按鈕
                submitBtn.disabled = false;
                submitBtn.textContent = '儲存變更';
            }
        });

        // 添加字數統計功能
        document.getElementById('register-introduction').addEventListener('input', function() {
            document.getElementById('intro-char-count').textContent = this.value.length;
        });

        document.getElementById('edit-introduction').addEventListener('input', function() {
            document.getElementById('edit-intro-char-count').textContent = this.value.length;
        });

    </script>

    <!-- 全屏圖片查看模態窗口 -->
    <div id="fullscreen-image-modal" class="modal">
        <div class="modal-content" style="max-width: 100%; padding: 0; background: black;">
            <div class="modal-header" style="background: rgba(0,0,0,0.7);">
                <h3>查看圖片</h3>
                <span class="close" id="close-fullscreen-modal">&times;</span>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div class="fullscreen-slider-container">
                    <!-- 全屏圖片將在這裡顯示 -->
                </div>
                <div class="fullscreen-slider-nav"></div>
                
                <div class="zoom-controls">
                    <button id="zoom-in" class="btn">放大</button>
                    <button id="zoom-reset" class="btn">重置</button>
                    <button id="zoom-out" class="btn">縮小</button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
